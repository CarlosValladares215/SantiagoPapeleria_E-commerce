<div class="space-y-6 max-w-6xl mx-auto p-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Gestión de Variantes</h1>
            <p class="text-gray-600 mt-1" *ngIf="parentProduct">
                Configurando variantes para: <span class="font-semibold">{{ parentProduct.webName }}</span>
            </p>
        </div>
        <button (click)="handleBack()"
            class="flex items-center space-x-2 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer whitespace-nowrap">
            <i class="ri-arrow-left-line"></i>
            <span>Volver a Enriquecer</span>
        </button>
    </div>

    <!-- Unsaved Changes Warning -->
    <div *ngIf="hasUnsavedChanges"
        class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex items-start space-x-3">
        <i class="ri-alert-line text-yellow-600 text-xl mt-0.5"></i>
        <div>
            <h3 class="font-semibold text-yellow-900 text-sm">Cambios sin guardar</h3>
            <p class="text-yellow-800 text-sm mt-1">
                Tienes cambios sin guardar. Asegúrate de guardar antes de salir de esta página.
            </p>
        </div>
    </div>

    <!-- Variant Groups Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Grupos de Variantes</h2>
                    <p class="text-sm text-gray-600 mt-1">
                        Define los atributos que diferencian tus productos (máximo 3 grupos)
                    </p>
                </div>
                <button (click)="openGroupModal()" [disabled]="groups.length >= 3"
                    class="px-4 py-2 bg-[#104D73] text-white rounded-lg hover:bg-[#0d3d59] transition-colors cursor-pointer whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                    <i class="ri-add-line mr-2"></i>
                    Agregar Grupo
                </button>
            </div>
        </div>

        <div *ngIf="groups.length > 0; else noGroups">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Nombre del Grupo</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Opciones</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Cantidad</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @for (group of groups; track group.id) {
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3 text-sm font-medium text-gray-800">{{ group.name }}</td>
                            <td class="px-4 py-3">
                                <div class="flex flex-wrap gap-1">
                                    @for (option of group.options.slice(0, 5); track option) {
                                    <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">
                                        {{ option }}
                                    </span>
                                    }
                                    <span *ngIf="group.options.length > 5" class="text-xs text-gray-500">
                                        +{{ group.options.length - 5 }} más
                                    </span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">{{ group.options.length }} opciones</td>
                            <td class="px-4 py-3 text-right">
                                <div class="flex items-center justify-end space-x-2">
                                    <button (click)="openGroupModal(group)"
                                        class="p-2 text-gray-600 hover:text-[#104D73] hover:bg-gray-100 rounded transition-colors cursor-pointer"
                                        title="Editar">
                                        <i class="ri-pencil-line"></i>
                                    </button>
                                    <button (click)="handleDeleteGroup(group.id)"
                                        class="p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors cursor-pointer"
                                        title="Eliminar">
                                        <i class="ri-delete-bin-line"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div *ngIf="groups.length < 3" class="p-4 bg-blue-50 border-t border-gray-100">
                <p class="text-xs text-gray-500">
                    <i class="ri-information-line mr-1"></i>
                    Puedes agregar hasta {{ 3 - groups.length }} grupo{{ 3 - groups.length !== 1 ? 's' : '' }} más
                </p>
            </div>
        </div>

        <ng-template #noGroups>
            <div class="text-center py-8">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="ri-list-settings-line text-gray-400 text-2xl"></i>
                </div>
                <p class="text-sm text-gray-600">No hay grupos de variantes. Crea uno para comenzar.</p>
            </div>
        </ng-template>
    </div>

    <!-- Variant Combinations Section -->
    <div *ngIf="groups.length > 0" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class="ri-grid-line mr-2 text-[#104D73]"></i>
                Combinaciones de Variantes
            </h2>
            <button (click)="generateVariants()"
                class="flex items-center space-x-2 px-4 py-2 bg-[#104D73] text-white rounded-lg hover:bg-[#0d3d5a] transition-colors text-sm font-medium cursor-pointer whitespace-nowrap">
                <i class="ri-refresh-line"></i>
                <span>{{ variants.length > 0 ? 'Regenerar' : 'Generar' }} Variantes</span>
            </button>
        </div>

        <div *ngIf="variants.length > 0; else noVariants">
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-900">
                    <i class="ri-information-line mr-1"></i>
                    {{ variants.length }} variante{{ variants.length !== 1 ? 's' : '' }} generada{{ variants.length !==
                    1 ? 's' : '' }}
                </p>
            </div>

            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Combinación</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">SKU</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Precio</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Stock</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Imágenes</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @for (variant of variants; track variant.id) {
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-3 text-sm font-medium text-gray-800">
                                {{ getCombinationLabel(variant.combination) }}
                            </td>
                            <td class="px-4 py-3">
                                <input type="text" [ngModel]="variant.sku"
                                    (ngModelChange)="updateVariant(variant.id, 'sku', $event)"
                                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-[#104D73] focus:border-transparent" />
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" step="0.01" min="0" [ngModel]="variant.price_override"
                                    (ngModelChange)="updateVariant(variant.id, 'price_override', $event)"
                                    [placeholder]="'$' + (parentProduct?.price | number:'1.2-2')"
                                    class="w-24 px-2 py-1 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-[#104D73] focus:border-transparent" />
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" min="0" [ngModel]="variant.stock"
                                    (ngModelChange)="updateVariant(variant.id, 'stock', $event)"
                                    class="w-20 px-2 py-1 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-[#104D73] focus:border-transparent" />
                            </td>
                            <td class="px-4 py-3">
                                <button (click)="toggleVariantActive(variant.id)"
                                    class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors cursor-pointer"
                                    [class]="variant.active ? 'bg-green-500' : 'bg-gray-300'">
                                    <span
                                        class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"
                                        [class]="variant.active ? 'translate-x-5' : 'translate-x-1'"></span>
                                </button>
                            </td>
                            <td class="px-4 py-3">
                                <button (click)="openImageModal(variant)"
                                    class="flex items-center space-x-1 text-xs text-[#104D73] hover:underline cursor-pointer whitespace-nowrap">
                                    <i class="ri-image-line"></i>
                                    <span>{{ variant.images.length }} imag.</span>
                                </button>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <button (click)="handleDeleteVariant(variant.id)"
                                    class="p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors cursor-pointer"
                                    title="Eliminar">
                                    <i class="ri-delete-bin-line h-4 w-4"></i>
                                </button>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <ng-template #noVariants>
            <div class="text-center py-8">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="ri-grid-line text-gray-400 text-2xl"></i>
                </div>
                <p class="text-sm text-gray-600 mb-2">No hay variantes generadas</p>
                <p class="text-xs text-gray-500">Haz clic en "Generar Variantes" para crear combinaciones</p>
            </div>
        </ng-template>
    </div>

    <!-- Bottom Action Buttons -->
    <div *ngIf="variants.length > 0" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
            <button (click)="hasUnsavedChanges = false; variants = []; groups = []"
                class="text-red-600 hover:text-red-700 text-sm font-medium cursor-pointer whitespace-nowrap">
                Descartar Cambios
            </button>
            <button (click)="handleSave()" [disabled]="isSaving"
                class="px-6 py-2 bg-[#104D73] text-white rounded-lg hover:bg-[#0d3d59] transition-colors cursor-pointer whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                <ng-container *ngIf="isSaving; else saveText">
                    <i class="ri-loader-line animate-spin mr-2"></i>
                    Guardando...
                </ng-container>
                <ng-template #saveText>
                    <i class="ri-save-line mr-2"></i>
                    Guardar Variantes
                </ng-template>
            </button>
        </div>
    </div>
</div>

<!-- Group Modal -->
<div *ngIf="isGroupModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        <!-- Modal Header -->
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">
                {{ editingGroup ? 'Editar Grupo de Variantes' : 'Nuevo Grupo de Variantes' }}
            </h3>
            <button (click)="closeGroupModal()" class="text-gray-400 hover:text-gray-600 cursor-pointer">
                <i class="ri-close-line text-xl"></i>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 overflow-y-auto flex-1">
            <div class="space-y-6">
                <!-- Step 1: Select Type -->
                <div *ngIf="!selectedGroupType">
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Selecciona el tipo de variante</h4>
                    <div class="grid grid-cols-2 gap-3">
                        @for (key of predefinedTypeKeys; track key) {
                        <button (click)="handleGroupTypeSelect(key)"
                            class="p-4 border-2 border-gray-200 rounded-lg hover:border-[#104D73] hover:bg-blue-50 transition-all cursor-pointer text-left">
                            <div class="flex items-center space-x-3">
                                <div
                                    class="w-10 h-10 bg-[#104D73] bg-opacity-10 rounded-lg flex items-center justify-center">
                                    <i [class]="PREDEFINED_TYPES[key].icon" class="text-[#104D73] text-xl"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">{{ PREDEFINED_TYPES[key].label }}</div>
                                    <div class="text-xs text-gray-500">
                                        {{ PREDEFINED_TYPES[key].suggestions.length > 0 ?
                                        PREDEFINED_TYPES[key].suggestions.length + ' opciones sugeridas' : 'Define tus
                                        propias opciones' }}
                                    </div>
                                </div>
                            </div>
                        </button>
                        }
                    </div>
                </div>

                <!-- Step 2: Configure Options -->
                <div *ngIf="selectedGroupType">
                    <!-- Type Header -->
                    <div class="flex items-center justify-between pb-4 border-b border-gray-200">
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-10 h-10 bg-[#104D73] bg-opacity-10 rounded-lg flex items-center justify-center">
                                <i [class]="PREDEFINED_TYPES[selectedGroupType].icon"
                                    class="text-[#104D73] text-xl"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">
                                    {{ selectedGroupType === 'custom' ? 'Grupo Personalizado' :
                                    PREDEFINED_TYPES[selectedGroupType].label }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    {{ newGroupOptions.length }} opciones seleccionadas
                                </div>
                            </div>
                        </div>
                        <button (click)="selectedGroupType = null"
                            class="text-sm text-gray-600 hover:text-gray-900 cursor-pointer flex items-center">
                            <i class="ri-arrow-left-line mr-1"></i>
                            Cambiar tipo
                        </button>
                    </div>

                    <!-- Custom Name Input -->
                    <div *ngIf="selectedGroupType === 'custom'">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Nombre del Grupo <span class="text-red-500">*</span>
                        </label>
                        <input type="text" [(ngModel)]="newGroupName" placeholder="Ej: Estilo, Acabado..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-[#104D73] focus:border-[#104D73] text-sm">
                    </div>

                    <!-- Suggestions -->
                    <div *ngIf="PREDEFINED_TYPES[selectedGroupType].suggestions.length > 0">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Opciones Sugeridas</label>
                        <div class="grid grid-cols-3 gap-2">
                            @for (sug of PREDEFINED_TYPES[selectedGroupType].suggestions; track sug.value) {
                            <button (click)="toggleSuggestedOption(sug.value)"
                                class="px-3 py-2 rounded-lg border-2 transition-all cursor-pointer text-sm font-medium flex items-center justify-center"
                                [class]="newGroupOptions.includes(sug.value) ? 'border-[#104D73] bg-[#104D73] text-white' : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300'">
                                <span *ngIf="sug.color"
                                    class="inline-block w-4 h-4 rounded-full mr-2 border border-gray-300"
                                    [style.backgroundColor]="sug.color"></span>
                                {{ sug.value }}
                            </button>
                            }
                        </div>
                    </div>

                    <!-- Custom Option Add -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Agregar Opción Personalizada</label>
                        <div class="flex space-x-2">
                            <input type="text" [(ngModel)]="customOptionInput" (keyup.enter)="addCustomOption()"
                                placeholder="Escribe y presiona Enter"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-[#104D73] focus:border-[#104D73] text-sm">
                            <button (click)="addCustomOption()"
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors cursor-pointer">
                                <i class="ri-add-line"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Options Tags -->
                    <div *ngIf="newGroupOptions.length > 0">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Opciones Seleccionadas</label>
                        <div class="flex flex-wrap gap-2">
                            @for (opt of newGroupOptions; track opt) {
                            <span
                                class="inline-flex items-center px-3 py-1 bg-blue-50 text-[#104D73] rounded-full text-sm font-medium">
                                {{ opt }}
                                <button (click)="removeOption(opt)"
                                    class="ml-2 text-[#104D73] hover:text-red-600 cursor-pointer">
                                    <i class="ri-close-line"></i>
                                </button>
                            </span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Actions -->
        <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
            <button (click)="closeGroupModal()"
                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer whitespace-nowrap">
                Cancelar
            </button>
            <button (click)="handleSaveGroup()" [disabled]="!selectedGroupType || newGroupOptions.length < 2"
                class="px-4 py-2 bg-[#104D73] text-white rounded-lg hover:bg-[#0d3d59] transition-colors cursor-pointer whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed">
                {{ editingGroup ? 'Actualizar Grupo' : 'Crear Grupo' }}
            </button>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div *ngIf="isImageModalOpen && selectedVariantForImages"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">
                Gestionar Imágenes - {{ getCombinationLabel(selectedVariantForImages.combination) }}
            </h3>
        </div>

        <div class="p-6 space-y-4">
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                    <label class="text-sm font-medium text-gray-700">Usar imágenes del producto base</label>
                    <p class="text-xs text-gray-500">Las imágenes del producto padre se mostrarán automáticamente</p>
                </div>
                <button (click)="useParentImages = !useParentImages"
                    class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors cursor-pointer"
                    [class]="useParentImages ? 'bg-[#104D73]' : 'bg-gray-300'">
                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                        [class]="useParentImages ? 'translate-x-6' : 'translate-x-1'"></span>
                </button>
            </div>

            <div *ngIf="!useParentImages">
                <!-- Gallery -->
                <div class="grid grid-cols-4 gap-3">
                    @for (img of variantImages; track img; let i = $index) {
                    <div class="relative group">
                        <img [src]="img" class="w-full h-24 object-cover rounded-lg border border-gray-200">
                        <div *ngIf="i === 0"
                            class="absolute top-1 left-1 bg-[#104D73] text-white text-xs px-1.5 py-0.5 rounded">
                            Principal</div>
                        <button (click)="handleDeleteImage(i)"
                            class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                            <i class="ri-delete-bin-line h-3 w-3"></i>
                        </button>
                    </div>
                    }
                    <div *ngIf="variantImages.length < 8" (click)="handleImageUpload()"
                        class="w-full h-24 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center hover:border-[#104D73] transition-colors cursor-pointer text-[#104D73]">
                        <i class="ri-upload-cloud-line text-2xl"></i>
                    </div>
                </div>
                <!-- Hidden File Input for Variant Images -->
                <input type="file" id="variantImageUpload" accept="image/png, image/jpeg, image/jpg, image/webp" hidden
                    (change)="onFileSelected($event)">
            </div>
        </div>

        <div class="p-6 border-t border-gray-200 flex items-center justify-end space-x-3">
            <button (click)="closeImageModal()"
                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium cursor-pointer">Cancelar</button>
            <button (click)="handleSaveImages()"
                class="px-4 py-2 bg-[#104D73] text-white rounded-lg hover:bg-[#0d3d5a] transition-colors text-sm font-medium cursor-pointer">Guardar
                Imágenes</button>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div *ngIf="showConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
        <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="ri-alert-line text-amber-600 text-2xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 text-center mb-2">Confirmar Acción</h3>
        <p class="text-sm text-gray-600 text-center mb-6">{{ confirmMessage }}</p>
        <div class="flex items-center justify-end space-x-3">
            <button (click)="showConfirmModal = false"
                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button (click)="confirmAction()"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Confirmar</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div *ngIf="showToast"
    class="fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 animate-fade-in z-50 text-white"
    [class]="toastType === 'success' ? 'bg-green-500' : 'bg-red-500'">
    <i [class]="toastType === 'success' ? 'ri-check-line' : 'ri-error-warning-line'"></i>
    <span class="text-sm font-medium">{{ toastMessage }}</span>
</div>