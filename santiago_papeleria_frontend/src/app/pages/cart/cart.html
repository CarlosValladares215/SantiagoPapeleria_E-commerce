<div class="bg-gray-50 min-h-screen pb-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 mb-6 text-xs text-[#104D73]/80">
            <a routerLink="/" class="hover:text-[#F2CB07] transition-colors">Inicio</a>
            <span class="material-symbols-outlined text-[10px]">chevron_right</span>
            <span class="text-[#104D73] font-bold">Carrito de Compras</span>
        </nav>

        <!-- Items List -->
        @if (cartService.cartItems().length === 0) {
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-12 text-center flex flex-col items-center">
            <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mb-6 text-gray-300">
                <i class="ri-shopping-bag-3-fill text-5xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-[#012e40] mb-2">Tu carrito está vacío</h2>
            <p class="text-gray-500 mb-8 max-w-md">No has agregado productos a tu carrito todavía. Explora nuestro
                catálogo y encuentra lo que necesitas.</p>
            <a routerLink="/products"
                class="bg-[#f2cb07] hover:bg-[#e0bc06] text-[#012e40] font-bold py-3 px-8 rounded-md transition-colors flex items-center gap-2">
                <i class="ri-arrow-left-line"></i> Ir a Comprar
            </a>
        </div>
        } @else {
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- LEFT COLUMN -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Products List -->
                <div class="space-y-4">
                    @for (item of cartService.cartItems(); track $index) {
                    <div
                        class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex gap-4 items-start sm:items-center">
                        <!-- Image -->
                        <div
                            class="w-20 h-20 bg-gray-50 rounded-md overflow-hidden flex-shrink-0 border border-gray-200">
                            <img [src]="item.image" [alt]="item.name" class="w-full h-full object-cover">
                        </div>

                        <!-- Details -->
                        <div class="flex-grow">
                            <h3 class="font-bold text-[#012e40] text-sm sm:text-base mb-1">{{ item.name }}</h3>
                            <p class="text-xs text-gray-500 mb-2">SKU: {{ item.sku }}</p>

                            <!-- Wholesale Badge -->
                            @if (item.quantity >= 12) {
                            <div
                                class="inline-flex items-center gap-1 bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded-full mb-1 border border-yellow-200">
                                <i class="ri-price-tag-3-fill"></i> Mayorista
                            </div>
                            }

                            <div class="flex items-baseline gap-2 sm:hidden">
                                @if (item.quantity >= 12 && item.retailPrice && item.price < item.retailPrice) { <span
                                    class="text-xs text-gray-400 line-through">{{ item.retailPrice | currency }}</span>
                                    }
                                    <div class="text-[#f2cb07] font-bold">
                                        {{ item.price | currency }}
                                    </div>
                            </div>
                            <div class="hidden sm:block">
                                @if (item.quantity >= 12 && item.retailPrice && item.price < item.retailPrice) { <span
                                    class="text-xs text-gray-400 line-through">{{ item.retailPrice | currency }}</span>
                                    }
                            </div>

                            <!-- Quantity Controls -->
                            <div class="flex flex-col items-end gap-3 sm:flex-row sm:items-center sm:gap-6">
                                <div class="flex items-center border border-gray-200 rounded-md">
                                    <button (click)="decreaseQuantity(item.id, item.quantity)"
                                        class="px-3 py-1 hover:bg-gray-100 text-gray-600 disabled:opacity-50"
                                        [disabled]="item.quantity <= 1">-</button>
                                    <span class="px-3 py-1 text-sm font-bold text-[#012e40] w-8 text-center">{{
                                        item.quantity }}</span>
                                    <button (click)="increaseQuantity(item.id, item.quantity)"
                                        class="px-3 py-1 hover:bg-gray-100 text-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                        [disabled]="item.quantity >= item.stock">+</button>
                                </div>

                                <div class="text-right hidden sm:block w-24">
                                    <div class="text-xs text-gray-400">Total</div>
                                    <div class="font-bold text-[#0f4c75]">{{ item.price * item.quantity | currency }}
                                    </div>
                                </div>

                                <button (click)="removeItem(item.id)" class="text-red-400 hover:text-red-600 p-1">
                                    <i class="ri-delete-bin-line text-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    }

                    <!-- Empty Cart Action -->
                    <div class="flex justify-end pt-2">
                        <button (click)="clearCart()"
                            class="text-red-500 hover:text-red-700 font-semibold text-sm flex items-center gap-2 px-3 py-1.5 rounded hover:bg-red-50 transition-colors">
                            <i class="ri-delete-bin-line"></i> Vaciar todo el carrito
                        </button>
                    </div>

                    <!-- Delivery Options -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                        <h3 class="font-bold text-[#012e40] mb-4 flex items-center gap-2">
                            <i class="ri-truck-line"></i> Método de Entrega
                        </h3>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Shipping Option -->
                            <label
                                class="relative flex items-center p-4 border rounded-lg cursor-pointer transition-all hover:bg-gray-50"
                                [class.border-[#f2cb07]]="cartService.deliveryMethod() === 'shipping'"
                                [class.bg-yellow-50]="cartService.deliveryMethod() === 'shipping'"
                                [class.border-gray-200]="cartService.deliveryMethod() !== 'shipping'">
                                <input type="radio" name="delivery" value="shipping"
                                    [checked]="cartService.deliveryMethod() === 'shipping'"
                                    (change)="setDelivery('shipping')" class="hidden">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-blue-100 text-[#0f4c75] flex items-center justify-center">
                                        <i class="ri-truck-fill text-xl"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-[#012e40]">Envío a Domicilio</div>
                                        <div class="text-xs text-gray-500">Recibe en tu dirección</div>
                                    </div>
                                </div>
                                @if(cartService.deliveryMethod() === 'shipping') {
                                <div class="absolute top-2 right-2 text-[#f2cb07]">
                                    <i class="ri-checkbox-circle-fill text-xl"></i>
                                </div>
                                }
                            </label>

                            <!-- Pickup Option -->
                            <label
                                class="relative flex items-center p-4 border rounded-lg cursor-pointer transition-all hover:bg-gray-50"
                                [class.border-[#f2cb07]]="cartService.deliveryMethod() === 'pickup'"
                                [class.bg-yellow-50]="cartService.deliveryMethod() === 'pickup'"
                                [class.border-gray-200]="cartService.deliveryMethod() !== 'pickup'">
                                <input type="radio" name="delivery" value="pickup"
                                    [checked]="cartService.deliveryMethod() === 'pickup'"
                                    (change)="setDelivery('pickup')" class="hidden">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-green-100 text-green-700 flex items-center justify-center">
                                        <i class="ri-store-2-fill text-xl"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-[#012e40]">Retiro en Tienda</div>
                                        <div class="text-xs text-gray-500">Sin costo de envío</div>
                                    </div>
                                </div>
                                @if(cartService.deliveryMethod() === 'pickup') {
                                <div class="absolute top-2 right-2 text-[#f2cb07]">
                                    <i class="ri-checkbox-circle-fill text-xl"></i>
                                </div>
                                }
                            </label>
                        </div>

                        <!-- Address Selection (Only if Shipping) -->
                        @if (cartService.deliveryMethod() === 'shipping') {
                        <div class="mt-6 pt-6 border-t border-gray-100 animate-fadeIn">
                            @if (authService.user()) {
                            @if (addresses().length > 0) {
                            <div class="mb-4">
                                <label class="block text-xs font-bold text-gray-600 mb-2">Selecciona tu dirección de
                                    envío:</label>
                                <select (change)="onAddressChange($event)"
                                    class="w-full bg-gray-50 border border-gray-200 rounded p-2.5 text-sm focus:border-[#f2cb07] outline-none">
                                    <option value="" selected>Seleccionar...</option>
                                    @for (addr of addresses(); track $index; let i = $index) {
                                    <option [value]="i">{{ addr.alias }} - {{ addr.ciudad }}</option>
                                    }
                                </select>
                            </div>
                            } @else {
                            <p
                                class="text-sm text-gray-500 mb-4 bg-yellow-50 p-3 rounded border border-yellow-100 flex items-start gap-2">
                                <i class="ri-alert-line text-yellow-600 mt-0.5"></i>
                                No tienes direcciones guardadas. Agrega una para calcular el envío.
                            </p>
                            }

                            <button (click)="addNewAddress()"
                                class="w-full border border-dashed border-gray-300 text-gray-600 hover:border-[#f2cb07] hover:text-[#012e40] font-semibold py-2 rounded-md transition-colors text-sm flex items-center justify-center gap-2">
                                <i class="ri-add-line"></i> Agregar Nueva Dirección
                            </button>
                            } @else {
                            <div class="bg-blue-50 p-6 rounded-lg border border-blue-100 text-center animate-fadeIn">
                                <div
                                    class="w-12 h-12 bg-blue-100 text-[#0f4c75] rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="ri-user-received-2-line text-xl"></i>
                                </div>
                                <h4 class="font-bold text-[#012e40] text-sm mb-2">¿Quieres envío a domicilio?</h4>
                                <p class="text-xs text-gray-600 mb-4">Para gestionar tus direcciones de envío y calcular
                                    costos exactos, necesitas iniciar sesión.</p>
                                <a routerLink="/login" [queryParams]="{ returnUrl: '/cart' }"
                                    class="inline-flex items-center gap-2 bg-[#0f4c75] text-white px-6 py-2 rounded-md text-sm font-bold hover:bg-[#0b3a5a] transition-colors shadow-md">
                                    <i class="ri-login-box-line"></i> Iniciar Sesión Ahora
                                </a>
                            </div>
                            }
                        </div>
                        }

                        <!-- Branch Selection (Only if Pickup) -->
                        @if (cartService.deliveryMethod() === 'pickup') {
                        <div class="mt-6 pt-6 border-t border-gray-100 animate-fadeIn">
                            <label class="block text-xs font-bold text-gray-600 mb-2">Selecciona la sucursal de
                                retiro:</label>

                            <select (change)="onBranchChange($event)"
                                class="w-full bg-gray-50 border border-gray-200 rounded p-2.5 text-sm focus:border-[#f2cb07] outline-none mb-4">
                                @for (branch of cartService.branches; track branch.id) {
                                <option [value]="branch.id" [selected]="cartService.selectedBranch().id === branch.id">
                                    {{ branch.name }}
                                </option>
                                }
                            </select>

                            @if (cartService.selectedBranch(); as branch) {
                            <div class="bg-blue-50 border-l-4 border-[#0f4c75] p-4 rounded-r shadow-sm">
                                <div class="flex items-start gap-3">
                                    <i class="ri-map-pin-line text-[#0f4c75] mt-1"></i>
                                    <div>
                                        <h4 class="font-bold text-[#012e40] text-sm">{{ branch.name }}</h4>
                                        <p class="text-sm text-gray-600 mt-1">{{ branch.address }}</p>
                                        <div class="flex items-center gap-2 mt-2 text-xs text-gray-500 font-medium">
                                            <i class="ri-time-line"></i>
                                            <span>{{ branch.schedule }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 text-xs text-green-600 flex items-center gap-1 font-semibold">
                                <i class="ri-notification-3-line"></i>
                                Te notificaremos cuando tu pedido esté listo para retirar.
                            </div>
                            }
                        </div>
                        }
                    </div>

                    <!-- Payment Options -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                        <h3 class="font-bold text-[#012e40] mb-4 flex items-center gap-2">
                            <i class="ri-bank-card-line"></i> Método de Pago
                        </h3>

                        <div class="space-y-3">
                            <!-- Transfer -->
                            @if (cartService.paymentConfig()?.transferActive) {
                            <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50"
                                [class.border-[#f2cb07]]="cartService.paymentMethod() === 'transfer'"
                                [class.bg-yellow-50]="cartService.paymentMethod() === 'transfer'">
                                <input type="radio" name="payment" value="transfer" (change)="setPayment('transfer')"
                                    class="accent-[#f2cb07] h-4 w-4">
                                <div class="ml-3">
                                    <div class="font-bold text-[#012e40] text-sm">Transferencia Bancaria</div>
                                    <div class="text-xs text-gray-500">Envía el comprobante para confirmar</div>
                                </div>
                                <i class="ri-bank-line ml-auto text-xl text-gray-400"></i>
                            </label>

                            @if(cartService.paymentMethod() === 'transfer') {
                            <div class="ml-8 p-4 bg-blue-50 rounded-lg border border-blue-100 text-sm animate-fadeIn">
                                <p class="font-bold text-[#0f4c75] mb-2">Cuentas Disponibles:</p>
                                <div class="space-y-3 mb-4">
                                    @for (acc of cartService.paymentConfig()?.bankAccounts; track acc._id) {
                                    <div class="bg-white p-2 rounded border border-blue-100 shadow-sm">
                                        <p class="font-bold text-blue-800">{{ acc.bankName }} - {{ acc.type }}</p>
                                        <p class="text-gray-600 font-mono">{{ acc.accountNumber }}</p>
                                        <p class="text-xs text-gray-500">{{ acc.ownerName }} ({{ acc.ownerId }})</p>
                                    </div>
                                    } @empty {
                                    <p class="text-xs text-red-500">No hay cuentas configuradas.</p>
                                    }
                                </div>

                                <div class="border-t border-blue-100 pt-3">
                                    <label class="block font-bold text-[#0f4c75] mb-2 text-xs uppercase tracking-wide">
                                        Subir Comprobante (Imagen/PDF)
                                    </label>
                                    <input type="file" (change)="onFileSelected($event)" accept="image/*,.pdf" class="block w-full text-sm text-gray-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-full file:border-0
                                        file:text-xs file:font-semibold
                                        file:bg-[#0f4c75] file:text-white
                                        hover:file:bg-[#0b3a5a]
                                        cursor-pointer bg-white rounded p-1 border border-blue-100
                                        ">
                                </div>
                            </div>
                            }
                            }

                            <!-- Cash -->
                            @if (cartService.paymentConfig()?.cashActive) {
                            <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50"
                                [class.border-[#f2cb07]]="cartService.paymentMethod() === 'cash'"
                                [class.bg-yellow-50]="cartService.paymentMethod() === 'cash'"
                                [class.opacity-50]="cartService.finalTotal() > (cartService.paymentConfig()?.cashConfig?.maxAmount || 0) && cartService.paymentConfig()?.cashConfig?.maxAmount! > 0">
                                <input type="radio" name="payment" value="cash" (change)="setPayment('cash')"
                                    class="accent-[#f2cb07] h-4 w-4"
                                    [disabled]="cartService.finalTotal() > (cartService.paymentConfig()?.cashConfig?.maxAmount || 0) && cartService.paymentConfig()?.cashConfig?.maxAmount! > 0">
                                <div class="ml-3">
                                    <div class="font-bold text-[#012e40] text-sm">Efectivo / Contraentrega</div>
                                    <div class="text-xs text-gray-500">Paga al recibir o retirar</div>
                                    @if(cartService.finalTotal() > (cartService.paymentConfig()?.cashConfig?.maxAmount
                                    || 0) && cartService.paymentConfig()?.cashConfig?.maxAmount! > 0) {
                                    <div class="text-[10px] text-red-500 font-bold mt-0.5">
                                        No disponible para montos mayores a {{
                                        cartService.paymentConfig()?.cashConfig?.maxAmount | currency }}
                                    </div>
                                    }
                                </div>
                                <i class="ri-money-dollar-circle-line ml-auto text-xl text-gray-400"></i>
                            </label>
                            }
                        </div>
                    </div>

                </div>
            </div>

            <!-- RIGHT COLUMN: Summary -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 sticky top-4">
                    <h3 class="font-bold text-[#012e40] mb-4 text-lg">Resumen de Compra</h3>

                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-gray-600 text-sm">
                            <span>Subtotal</span>
                            <span>{{ cartService.subTotal() | currency }}</span>
                        </div>
                        <div class="flex justify-between text-gray-600 text-sm">
                            <span>IVA ({{ cartService.ivaRate() * 100 | number:'1.0-0' }}%)</span>
                            <span>{{ cartService.totalIva() | currency }}</span>
                        </div>
                        <div class="flex justify-between text-gray-600 text-sm">
                            <span>Envío</span>
                            @if (cartService.deliveryMethod() === 'pickup') {
                            <span class="text-green-600 font-bold">Gratis (Retiro)</span>
                            } @else if (cartService.selectedAddress()) {
                            <div class="flex flex-col items-end">
                                @if (cartService.isFreeShipping()) {
                                <span class="text-green-600 font-bold">¡Envío Gratis!</span>
                                } @else {
                                <span>{{ cartService.shippingCost() | currency }}</span>
                                }

                                @if (cartService.shippingBreakdown(); as bd) {
                                <span class="text-[10px] text-gray-400 mt-1 text-right">
                                    @switch (bd.appliedRule) {
                                    @case ('CUSTOM_CITY') {
                                    <span class="block">Tarifa Fija Ciudad</span>
                                    }
                                    @case ('DISTANCE') {
                                    <span class="block">Por Distancia ({{ bd.distancePart | currency }})</span>
                                    @if (bd.weightPart > 0) { <span class="block">+ Peso ({{ bd.weightPart | currency
                                        }})</span> }
                                    }
                                    @case ('ZONE_WEIGHT') {
                                    <span class="block">Por Peso (Zona)</span>
                                    }
                                    @case ('GLOBAL_FALLBACK') {
                                    <span class="block">Tarifa Base Global</span>
                                    }
                                    }
                                    @if (cartService.selectedAddress(); as addr) {
                                    <span class="block text-[9px] italic mt-0.5 max-w-[120px] truncate">
                                        Enviando a: {{ addr.alias }} ({{ addr.ciudad }})
                                    </span>
                                    }
                                </span>
                                }
                            </div>
                            } @else {
                            <span class="text-xs text-gray-400 italic">Por calcular</span>
                            }
                        </div>
                        <div class="border-t border-gray-100 pt-3 flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="font-bold text-[#012e40]">Total Final</span>
                                <span class="text-[10px] text-gray-500 font-normal">Incluye IVA</span>
                            </div>
                            <span class="font-bold text-2xl text-[#f2cb07]">{{ cartService.finalTotal() | currency
                                }}</span>
                        </div>
                    </div>

                    <button (click)="confirmOrder()" [disabled]="isProcessing()"
                        class="w-full bg-[#0f4c75] hover:bg-[#0b3a5a] text-white font-bold py-3.5 rounded-md transition-colors flex justify-center items-center gap-2 shadow-lg shadow-blue-900/10 disabled:opacity-70 disabled:cursor-not-allowed">
                        @if (isProcessing()) {
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        <span>Procesando...</span>
                        } @else {
                        <span>Confirmar Pedido</span>
                        <i class="ri-check-double-line"></i>
                        }
                    </button>

                    <!-- Secure Badge -->
                    <div class="mt-4 text-center">
                        <div class="text-xs text-green-600 flex items-center justify-center gap-1">
                            <i class="ri-shield-check-fill"></i> Compra 100% Segura
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }

        <!-- Confirmation Modal -->
        @if (showConfirmModal()) {
        <div class="modal-overlay">
            <div class="modal-content">
                <div class="icon-wrapper" style="background-color: #fffbeb;">
                    <i class="ri-question-mark text-4xl text-[#f2cb07]"></i>
                </div>
                <h2>¿Confirmar Pedido?</h2>
                <p>
                    Estás a punto de realizar tu compra por un total de <strong>{{ cartService.finalTotal() | currency
                        }}</strong>.
                    ¿Deseas continuar?
                </p>

                <div class="flex gap-4 mt-6">
                    <button (click)="cancelOrder()"
                        class="flex-1 px-4 py-3 rounded-lg border border-gray-300 text-gray-700 font-bold hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button (click)="processOrderConfirmed()" [disabled]="isProcessing()"
                        class="flex-1 px-4 py-3 rounded-lg bg-[#0f4c75] text-white font-bold hover:bg-[#0b3a5a] transition-colors shadow-lg disabled:opacity-70 disabled:cursor-not-allowed">
                        @if (isProcessing()) {
                        <svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        } @else {
                        Sí, Confirmar
                        }
                    </button>
                </div>
            </div>
        </div>
        }

        <!-- Success Modal -->
        @if (showSuccessModal()) {
        <div class="modal-overlay">
            <div class="modal-content">
                <div class="icon-wrapper">
                    <i class="ri-checkbox-circle-fill"></i>
                </div>
                <h2>¡Pedido Confirmado!</h2>
                <p>
                    Hemos recibido tu pedido correctamente. La factura y los detalles han sido enviados a tu correo
                    electrónico registrado.
                </p>
                <button (click)="closeModalAndRedirect()" class="modal-btn">
                    Entendido, ir a mis pedidos
                </button>
            </div>
        </div>
        }
    </div>