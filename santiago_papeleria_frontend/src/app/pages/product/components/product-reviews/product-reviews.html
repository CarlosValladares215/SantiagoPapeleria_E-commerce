<div class="max-w-5xl mx-auto space-y-8">
  <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">

    <!-- REVIEWS EXIST -->
    <div *ngIf="reviews && reviews.length > 0; else emptyState">
      <div class="flex flex-col md:flex-row justify-between items-start mb-10">
        <div>
          <h2 class="text-2xl font-bold text-slate-900">Reseñas de Clientes</h2>
        </div>
        <div class="mt-4 md:mt-0 text-right">
          <div class="text-5xl font-extrabold text-blue-900">{{ avgRating() | number:'1.1-1' }}</div>
          <div class="flex items-center justify-end text-yellow-400 my-1 text-2xl">
            <ng-container *ngFor="let s of getStarsArray(5); let i = index">
              <i [class]="i < avgRating() ? 'ri-star-fill' : 'ri-star-line'"></i>
            </ng-container>
          </div>
          <div class="text-sm text-slate-500">{{ reviews.length }} reseñas</div>
        </div>
      </div>

      <!-- BARS -->
      <div class="space-y-4 max-w-4xl mb-12">
        <div class="flex items-center gap-4 group" *ngFor="let star of [5,4,3,2,1]">
          <span class="w-20 text-sm font-medium text-slate-700">{{ star }} estrellas</span>
          <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
            <div class="h-full bg-blue-600 transition-all duration-500" [style.width.%]="ratingPercent(star)"></div>
          </div>
          <span class="w-10 text-right text-sm font-medium text-slate-500">{{ ratingPercent(star) }}%</span>
        </div>
      </div>

      <!-- FILTERS -->
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4 px-2 mb-6">
        <h3 class="text-xl font-semibold text-slate-900">Opiniones más recientes</h3>
        <select (change)="setSort($event)"
          class="bg-white border-slate-200 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">
          <option value="newest">Más recientes</option>
          <option value="highest">Mejor puntuación</option>
          <option value="lowest">Peor puntuación</option>
        </select>
      </div>

      <!-- LIST -->
      <div class="space-y-6">
        <article *ngFor="let r of sortedReviews()"
          class="bg-white p-8 rounded-xl border border-slate-200 shadow-sm transition-transform hover:scale-[1.005]">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold uppercase">
                {{ r.user_name.charAt(0) }}
              </div>
              <div>
                <p class="font-semibold text-slate-900">{{ r.user_name }}</p>
                <div class="flex items-center gap-2">
                  <span
                    class="bg-green-100 text-green-700 text-[10px] uppercase font-bold px-2 py-0.5 rounded flex items-center">
                    <i class="ri-checkbox-circle-line mr-1"></i> Compra verificada
                  </span>
                </div>
              </div>
            </div>
            <div class="flex flex-col items-start md:items-end">
              <div class="flex text-yellow-400 text-lg">
                <ng-container *ngFor="let s of getStarsArray(5); let i = index">
                  <i [class]="i < r.rating ? 'ri-star-fill' : 'ri-star-line'"></i>
                </ng-container>
              </div>
              <span class="text-xs text-slate-400 mt-1">{{ r.date | date:'mediumDate' }}</span>
            </div>
          </div>
          <p class="text-slate-600 leading-relaxed">
            {{ r.comment }}
          </p>
        </article>
      </div>
    </div>

    <!-- EMPTY STATE TEMPLATE -->
    <ng-template #emptyState>
      <div class="text-center py-12">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 text-blue-600 mb-4">
          <i class="ri-chat-1-line text-3xl"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-900 mb-2">Aún no hay reseñas escritas</h3>
        <p class="text-slate-500 max-w-sm mx-auto mb-8">Sé el primero en compartir tu experiencia con el resto de la
          comunidad.</p>
      </div>
    </ng-template>

    <!-- WRITE REVIEW SECTION -->
    <div class="mt-12 border-t border-gray-100 pt-8">
      <div *ngIf="!isWriting()" class="text-center">
        <button (click)="toggleWrite()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-semibold inline-flex items-center gap-2 transition-all shadow-lg hover:shadow-blue-500/30">
          <i class="ri-edit-line text-xl"></i>
          Escribir una reseña
        </button>
      </div>

      <!-- FORM -->
      <div *ngIf="isWriting()" class="bg-slate-50 p-6 rounded-2xl border border-slate-200 animate-fade-in">
        <h3 class="text-lg font-bold text-slate-900 mb-4">Escribe tu opinión</h3>

        <form (ngSubmit)="submitReview()" #f="ngForm">
          <div class="space-y-4">
            <!-- Name -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Nombre</label>
              <input type="text" [(ngModel)]="newReview().user_name" name="user_name" required
                class="w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"
                placeholder="Tu nombre">
            </div>

            <!-- Rating -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Calificación</label>
              <div class="flex gap-1 text-2xl text-yellow-400 cursor-pointer">
                <ng-container *ngFor="let s of [1,2,3,4,5]">
                  <i [class]="s <= newReview().rating ? 'ri-star-fill' : 'ri-star-line'" (click)="setRating(s)"
                    class="hover:scale-110 transition-transform"></i>
                </ng-container>
              </div>
            </div>

            <!-- Comment -->
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Comentario</label>
              <textarea [(ngModel)]="newReview().comment" name="comment" required rows="4"
                class="w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"
                placeholder="¿Qué te pareció el producto?"></textarea>
            </div>

            <!-- Actions -->
            <div class="flex gap-3 justify-end pt-2">
              <button type="button" (click)="toggleWrite()"
                class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancelar</button>
              <button type="submit" [disabled]="!f.valid || isSubmitting()"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                {{ isSubmitting() ? 'Enviando...' : 'Publicar Reseña' }}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

  </section>
</div>