<div [class]="'bg-white rounded-3xl overflow-hidden shadow-md border transition-all duration-300 flex flex-col ' +
    (product.stock === 0 ? 'border-slate-200 opacity-75 grayscale-[30%]' : 'border-slate-100 hover:shadow-xl')">

    <!-- Image Section -->
    <div class="relative bg-slate-50 p-6 flex justify-center items-center aspect-square">
        <img [src]="getMainImage()" [alt]="product.name"
            class="object-contain max-h-48 max-w-full mix-blend-multiply" />

        <!-- Flash Sale Badge with Countdown - Top Left -->
        @if ((product.promocion_activa || product.discount) && product.stock > 0) {
        <div class="absolute top-4 left-4 z-20 flex flex-col gap-2">
            <span
                class="bg-red-600 text-white font-black text-sm px-4 py-2 rounded-xl shadow-lg shadow-red-500/30 flex items-center gap-1">
                -{{ product.promocion_activa ? product.promocion_activa.valor_descuento : product.discount }}
                {{ product.promocion_activa?.tipo_descuento === 'valor_fijo' ? '$' : '%' }}
                <span class="text-[10px] opacity-80 font-bold uppercase tracking-widest ml-1">Oferta</span>
            </span>
            <!-- Countdown Timer - Only show if promotion has end date -->
            @if (product.promocion_activa?.fecha_fin && countdownDisplay()) {
            <div
                class="bg-slate-900/80 backdrop-blur-md text-white px-3 py-1.5 rounded-lg flex items-center gap-2 border border-white/10">
                <i class="ri-timer-line text-red-400 text-sm"></i>
                <span class="text-[11px] font-bold">Termina:</span>
                <span class="font-mono text-[11px] font-bold tracking-wide ml-0.5">{{ countdownDisplay() }}</span>
            </div>
            }
        </div>
        }

        <!-- Favorite Button - Top Right -->
        <div class="absolute top-4 right-4">
            <button (click)="toggleFavorite($event)"
                class="w-10 h-10 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center shadow-md hover:bg-white hover:scale-110 transition-all">
                <i
                    [class]="'text-xl ' + (isFavorite() ? 'ri-heart-fill text-rose-500' : 'ri-heart-line text-slate-400')"></i>
            </button>
        </div>

        <!-- Out of Stock Overlay -->
        @if (product.stock === 0) {
        <div class="absolute inset-0 bg-slate-900/20 z-10 pointer-events-none"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20">
            <span
                class="bg-slate-800 text-white font-black text-xs px-4 py-2 rounded-lg shadow-xl tracking-widest uppercase">
                AGOTADO
            </span>
        </div>
        }
    </div>

    <!-- Product Info -->
    <div class="p-5 flex flex-col flex-1">
        <!-- Category -->
        <span class="text-[10px] uppercase tracking-wider font-bold text-slate-400 mb-1">
            {{ product.category }}
        </span>

        <!-- Product Name -->
        <h3 class="text-lg font-bold text-slate-800 leading-tight mb-3 line-clamp-2 min-h-[3rem]">
            {{ product.name }}
        </h3>

        <!-- Price Section -->
        <div class="flex items-baseline gap-3 mb-2">
            <!-- Final Price -->
            <span [class]="'text-2xl font-black ' + 
                (product.promocion_activa || product.discount ? 'text-red-600' : 'text-slate-900')">
                ${{ (product.promocion_activa ? product.promocion_activa.precio_descuento : product) |
                displayPrice | number:'1.2-2' }}
            </span>
            <!-- Original Price (struck through) -->
            @if (product.promocion_activa) {
            <span class="text-lg font-medium text-slate-400 line-through decoration-slate-400/50 decoration-2">
                ${{ product.promocion_activa.precio_original.toFixed(2) }}
            </span>
            } @else if (product.originalPrice || product.discount) {
            <span class="text-lg font-medium text-slate-400 line-through decoration-slate-400/50 decoration-2">
                ${{ getOriginalPrice().toFixed(2) }}
            </span>
            }
        </div>

        <!-- Stock Status Badge -->
        <div class="flex items-center gap-2 mb-4">
            @if (product.stock === 0) {
            <span
                class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1">
                <i class="ri-close-circle-fill text-xs"></i>
                Agotado
            </span>
            } @else if (product.stock < 10) { <span
                class="bg-red-50 text-red-600 text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1 border border-red-100">
                <i class="ri-error-warning-fill text-xs"></i>
                Solo {{ product.stock }} disponibles
                </span>
                } @else if (product.stock < 20) { <span
                    class="bg-amber-50 text-amber-600 text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1 border border-amber-100">
                    <i class="ri-alert-fill text-xs"></i>
                    Ãšltimas unidades
                    </span>
                    } @else {
                    <span
                        class="bg-green-50 text-green-600 text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1 border border-green-100">
                        <i class="ri-checkbox-circle-fill text-xs"></i>
                        En Stock
                    </span>
                    }
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-2 gap-3 mt-auto">
            <button (click)="onViewDetails()"
                class="py-3 px-4 rounded-xl border-2 border-slate-200 text-slate-700 font-bold text-sm hover:bg-slate-50 transition-colors">
                Ver Detalles
            </button>
            <button (click)="onAddToCart()" [disabled]="product.stock === 0"
                [class]="'py-3 px-4 rounded-xl font-bold text-sm transition-all ' +
                (product.stock === 0 
                    ? 'bg-slate-200 text-slate-400 cursor-not-allowed' 
                    : 'bg-[#F2CB07] text-slate-900 shadow-lg shadow-yellow-500/20 hover:scale-[1.02] active:scale-[0.98]')">
                {{ product.stock === 0 ? 'Agotado' : 'Agregar' }}
            </button>
        </div>
    </div>
</div>