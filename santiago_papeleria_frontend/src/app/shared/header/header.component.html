<!-- Header Principal -->
<header class="header" id="mainHeader">
  <!-- Top Bar (Coreano Style) -->
  <div class="header-top-bar">
    <div class="header-container">
      <div class="top-bar-content">
        <span class="top-bar-text"></span>
        <div class="top-bar-links">
          <a routerLink="/sucursales"><i class="fas fa-store"></i> Sucursales</a>
          <a routerLink="/contact"><i class="fas fa-headset"></i> Ayuda</a>
          <a routerLink="/tracking"><i class="fas fa-map-marker-alt"></i> Seguimiento</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Header -->
  <div class="bg-white">
    <div class="header-container">
      <div class="header-main">
        <!-- Logo -->
        <div class="header-left">
          <a routerLink="/" class="logo" aria-label="Santiago Papelería">
            <div class="logo-container">
              <img src="favicon.ico" alt="Santiago Papelería" class="logo-image" loading="eager">
              <div class="logo-text">
                <span class="logo-title">SANTIAGO</span>
                <span class="logo-subtitle">PAPELERÍA</span>
              </div>
            </div>
          </a>
        </div>

        <!-- Búsqueda (Estilo Coreano) -->
        <div class="header-center">
          <form class="search-container" (submit)="performSearch()" role="search" autocomplete="off">
            <div class="search-input-wrapper">
              <button type="submit" class="search-submit" aria-label="Buscar">
                <i class="fas fa-search"></i>
              </button>
              <input type="search" class="search-input" [(ngModel)]="searchQuery" name="search" placeholder="Buscar..."
                aria-label="Buscar productos">
            </div>
          </form>
        </div>

        <!-- Acciones de Usuario -->
        <ng-container *ngIf="auth.user(); else guestActions">
          <div class="logged-user-actions">
            <!-- Usuario Dropdown Trigger (Avatar + Info) -->
            <div class="user-dropdown" (mouseleave)="closeProfileMenu()">
              <button class="user-info-trigger" aria-label="Menú de usuario" (click)="toggleProfileMenu()">
                <div class="avatar-circle">
                  {{ getInitials(auth.user()?.nombres || '') }}
                </div>
                <div class="user-text-info">
                  <span class="u-name">
                    {{ auth.user()?.nombres?.split(' ')?.[0] }} {{ auth.user()?.nombres?.split(' ')?.[1] || '' }}
                    <i class="fas fa-chevron-down"></i>
                  </span>
                  <span class="u-role">{{ auth.user()?.tipo_cliente || 'Minorista' | titlecase }}</span>
                </div>
              </button>

              <!-- Card Menu -->
              <div class="user-card-dropdown" [class.show]="isProfileMenuOpen()">
                <div class="card-header">
                  <div class="card-avatar">
                    {{ getInitials(auth.user()?.nombres || '') }}
                  </div>
                  <div class="card-info">
                    <span class="user-name">{{ auth.user()?.nombres }}</span>
                    <span class="user-email">{{ auth.user()?.email }}</span>
                    <span class="user-role-badge">
                      {{ auth.user()?.tipo_cliente || 'Cliente' }}
                    </span>
                  </div>
                </div>
                <ul class="card-menu">
                  <li><a (click)="goToProfile()"><i class="far fa-user"></i> Mi Perfil</a></li>
                  <li><a routerLink="/orders"><i class="fas fa-shopping-bag"></i> Mis Pedidos</a></li>
                  <li><a routerLink="/favorites"><i class="far fa-heart"></i> Favoritos</a></li>
                </ul>
                <div class="card-footer">
                  <a (click)="logout()" class="logout-link"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
                </div>
              </div>
            </div>

            <!-- Carrito -->
            <button class="header-action-btn cart-btn-logged relative" aria-label="Carrito de compras"
              (click)="toggleCart()">
              <div class="relative inline-block">
                <i class="fas fa-shopping-cart text-lg"></i>
                <span *ngIf="cartService.cartCount() > 0"
                  class="absolute -top-2 -right-2 bg-[#ff0000] text-white text-[11px] font-bold h-[20px] min-w-[20px] flex items-center justify-center rounded-full border-[2px] border-white shadow-sm transform scale-100 transition-transform duration-200"
                  style="color: #ffffff !important; background-color: #ff0000 !important;">
                  {{ cartService.cartCount() }}
                </span>
              </div>
              <span class="ml-1 font-medium text-sm">Carrito</span>
            </button>

            <!-- Notificaciones -->
            <div class="header-dropdown-wrapper relative" (mouseleave)="closeNotifications()">
              <button class="header-action-btn notification-btn relative" aria-label="Notificaciones"
                (click)="toggleNotifications()">
                <div class="relative inline-block">
                  <i class="far fa-bell text-xl"></i>
                  <!-- Badge -->
                  <span *ngIf="notificationsService.unreadCount() > 0"
                    class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] min-w-[16px] h-4 flex items-center justify-center rounded-full border border-white">
                    {{ notificationsService.unreadCount() }}
                  </span>
                </div>
              </button>

              <!-- Notifications Dropdown -->
              <div class="notifications-dropdown" [class.show]="isNotificationsOpen()">
                <div class="noti-header">
                  <h3 class="text-sm font-bold text-gray-800">Notificaciones</h3>
                  <button *ngIf="notificationsService.unreadCount() > 0"
                    class="text-xs text-blue-600 hover:text-blue-800"
                    (click)="notificationsService.markAllAsRead(auth.user()?._id || '')">
                    Marcar todo como leído
                  </button>
                </div>

                <div class="noti-list max-h-80 overflow-y-auto">
                  @if (notificationsService.notifications().length === 0) {
                  <div class="p-4 text-center text-gray-500 text-xs">
                    No tienes notificaciones
                  </div>
                  } @else {
                  @for (notification of notificationsService.notifications(); track notification._id) {
                  <div class="noti-item" [class.unread]="!notification.leido"
                    (click)="notificationsService.markAsRead(notification._id)">
                    <div class="noti-icon">
                      <i class="fas fa-box-open text-blue-500"></i>
                    </div>
                    <div class="noti-content">
                      <p class="text-xs text-gray-800 leading-snug">{{ notification.mensaje }}</p>
                      <span class="text-[10px] text-gray-400 mt-1 block">{{ notification.createdAt | date:'short'
                        }}</span>
                    </div>
                    <div *ngIf="!notification.leido" class="w-2 h-2 bg-blue-500 rounded-full ml-2"></div>
                  </div>
                  }
                  }
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #guestActions>
          <div class="guest-actions">
            <!-- Botones de Sesión -->
            <div class="session-buttons">
              <a routerLink="/login" class="btn-login-header">Iniciar Sesión</a>
              <a routerLink="/register" class="btn-register-header">Registrarse</a>
            </div>

            <!-- Carrito Guest -->
            <button class="header-action-btn cart-btn-logged relative" aria-label="Carrito de compras"
              (click)="toggleCart()">
              <div class="relative inline-block">
                <i class="fas fa-shopping-cart text-lg"></i>
                <span *ngIf="cartService.cartCount() > 0"
                  class="absolute -top-2 -right-2 bg-[#ff0000] text-white text-[11px] font-bold h-[20px] min-w-[20px] flex items-center justify-center rounded-full border-[2px] border-white shadow-sm transform scale-100 transition-transform duration-200"
                  style="color: #ffffff !important; background-color: #ff0000 !important;">
                  {{ cartService.cartCount() }}
                </span>
              </div>
              <span class="ml-1 font-medium text-sm">Carrito</span>
            </button>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Navegación Principal (3 MEGAS) -->
  <nav class="header-navigation" aria-label="Navegación principal">
    <div class="header-container">
      <ul class="nav-list">
        <li class="nav-item">
          <a routerLink="/" class="nav-link active">
            <i class="fas fa-home"></i>
            <span>INICIO</span>
          </a>
        </li>

        <!-- Dynamic Categories from Backend -->
        <ng-container *ngFor="let cat of categories().slice(0, 5)">
          <li class="nav-item mega-parent" (mouseenter)="openMega(cat.slug)" (mouseleave)="scheduleCloseMega()"
            (mouseenter)="cancelCloseMega()">
            <a [routerLink]="['/products']" [queryParams]="{category: cat.nombre}" class="nav-link"
              [class.active]="megaMenu() === cat.slug">
              <i class="fas" [class.fa-th-large]="!cat.icono" [class]="cat.icono"></i>
              <span>{{ cat.nombre }}</span>
              <i *ngIf="cat.hijos?.length" class="fas fa-chevron-down arrow ml-1"></i>
            </a>
          </li>
        </ng-container>

        <!-- More categories dropdown if needed -->
        <li *ngIf="categories().length > 5" class="nav-item mega-parent" (mouseenter)="openMega('more-cats')"
          (mouseleave)="scheduleCloseMega()" (mouseenter)="cancelCloseMega()">
          <a class="nav-link" [class.active]="megaMenu() === 'more-cats'">
            <i class="fas fa-plus"></i>
            <span>MÁS</span>
            <i class="fas fa-chevron-down arrow ml-1"></i>
          </a>
        </li>

        <li class="nav-item">
          <a [routerLink]="['/offers']" class="nav-link highlight">
            <i class="fas fa-tag"></i>
            <span>OFERTAS ESPECIALES</span>
          </a>
        </li>

        <li class="nav-item">
          <a [routerLink]="['/products']" [queryParams]="{sort: 'newest'}" class="nav-link">
            <i class="fas fa-star"></i>
            <span>NUEVO</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- MEGA MENÚS DESPLEGABLES DINÁMICOS -->
  <div class="mega-menu-container" (mouseenter)="cancelCloseMega()" (mouseleave)="scheduleCloseMega()">

    <!-- One mega menu per category -->
    <ng-container *ngFor="let cat of categories().slice(0, 5)">
      <div class="mega-menu" [class.active]="megaMenu() === cat.slug">
        <div class="mega-content">
          <div class="mega-grid"
            [style.grid-template-columns]="'repeat(' + (cat.hijos?.length > 4 ? 4 : cat.hijos?.length || 1) + ', 1fr)'">
            <!-- For Level 2 categories, we show their children as sections or items -->
            <!-- If they have children (Level 3 ERP), we show them as sections -->
            <ng-container *ngIf="cat.hijos?.length">
              <div *ngFor="let subcat of cat.hijos" class="mega-section">
                <h3 class="mega-title">
                  <a [routerLink]="['/products']" [queryParams]="{category: subcat.nombre}">
                    {{ subcat.nombre }}
                  </a>
                </h3>
                <ul class="mega-list" *ngIf="subcat.hijos?.length">
                  <li *ngFor="let thirdLevel of subcat.hijos">
                    <a [routerLink]="['/products']" [queryParams]="{category: thirdLevel.nombre}">
                      {{ thirdLevel.nombre }}
                    </a>
                  </li>
                </ul>
              </div>
            </ng-container>

            <!-- If NO children, show something else or just the link -->
            <div *ngIf="!cat.hijos?.length" class="mega-section">
              <p class="text-sm text-gray-500">Ver todos los productos en {{ cat.nombre }}</p>
              <a [routerLink]="['/products']" [queryParams]="{category: cat.nombre}"
                class="btn-view-all mt-4 inline-block px-4 py-2 bg-blue-600 text-white rounded">Ver Todo</a>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- MEGA MENU for "MÁS" -->
    <div class="mega-menu" [class.active]="megaMenu() === 'more-cats'">
      <div class="mega-content">
        <div class="mega-grid" style="grid-template-columns: repeat(4, 1fr);">
          <div *ngFor="let cat of categories().slice(5)" class="mega-section">
            <h3 class="mega-title">
              <a [routerLink]="['/products']" [queryParams]="{category: cat.nombre}">
                {{ cat.nombre }}
              </a>
            </h3>
            <ul class="mega-list" *ngIf="cat.hijos?.length">
              <li *ngFor="let sub of cat.hijos">
                <a [routerLink]="['/products']" [queryParams]="{category: sub.nombre}">{{ sub.nombre }}</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>