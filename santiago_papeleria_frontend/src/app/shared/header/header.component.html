<!-- Header Principal -->
<header class="header" id="mainHeader">
  <!-- Top Bar (Coreano Style) -->
  <div class="header-top-bar">
    <div class="header-container">
      <div class="top-bar-content">
        <span class="top-bar-text"></span>
        <div class="top-bar-links">
          <a routerLink="/sucursales"><i class="fas fa-store"></i> Sucursales</a>
          <a routerLink="/contact"><i class="fas fa-headset"></i> Ayuda</a>
          <a routerLink="/tracking"><i class="fas fa-map-marker-alt"></i> Seguimiento</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Header -->
  <div class="bg-white">
    <div class="header-container">
      <div class="header-main">
        <!-- Logo -->
        <div class="header-left">
          <a routerLink="/" class="logo" aria-label="Santiago Papelería">
            <div class="logo-container">
              <img src="favicon.ico" alt="Santiago Papelería" class="logo-image" loading="eager">
              <div class="logo-text">
                <span class="logo-title">SANTIAGO</span>
                <span class="logo-subtitle">PAPELERÍA</span>
              </div>
            </div>
          </a>
        </div>

        <!-- Búsqueda (Estilo Coreano) -->
        <div class="header-center">
          <form class="search-container" (submit)="performSearch()" role="search" autocomplete="off">
            <div class="search-input-wrapper">
              <button type="submit" class="search-submit" aria-label="Buscar">
                <i class="fas fa-search"></i>
              </button>
              <input type="search" class="search-input" [(ngModel)]="searchQuery" name="search"
                placeholder="Buscar..." aria-label="Buscar productos">
            </div>
          </form>
        </div>

        <!-- Acciones de Usuario -->
        <ng-container *ngIf="auth.user(); else guestActions">
          <!-- Usuario Dropdown Trigger (Avatar + Info) -->
          <div class="user-dropdown" (mouseleave)="closeProfileMenu()">
            <button class="user-info-trigger" aria-label="Menú de usuario" (click)="toggleProfileMenu()">
              <div class="avatar-circle">
                {{ getInitials(auth.user()?.nombres || '') }}
              </div>
              <div class="user-text-info">
                <span class="u-name">
                  {{ auth.user()?.nombres?.split(' ')?.[0] }} {{ auth.user()?.nombres?.split(' ')?.[1] || '' }}
                  <i class="fas fa-chevron-down"></i>
                </span>
                <span class="u-role">{{ auth.user()?.tipo_cliente || 'Minorista' | titlecase }}</span>
              </div>
            </button>

            <!-- Card Menu -->
            <div class="user-card-dropdown" [class.show]="isProfileMenuOpen()">
              <div class="card-header">
                <div class="card-avatar">
                  {{ getInitials(auth.user()?.nombres || '') }}
                </div>
                <div class="card-info">
                  <span class="user-name">{{ auth.user()?.nombres }}</span>
                  <span class="user-email">{{ auth.user()?.email }}</span>
                  <span class="user-role-badge">
                    {{ auth.user()?.tipo_cliente || 'Cliente' }}
                  </span>
                </div>
              </div>
              <ul class="card-menu">
                <li><a (click)="goToProfile()"><i class="far fa-user"></i> Mi Perfil</a></li>
                <li><a routerLink="/orders"><i class="fas fa-shopping-bag"></i> Mis Pedidos</a></li>
                <li><a routerLink="/favorites"><i class="far fa-heart"></i> Favoritos</a></li>
              </ul>
              <div class="card-footer">
                <a (click)="logout()" class="logout-link"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
              </div>
            </div>
          </div>

          <!-- Carrito -->
          <button class="header-action-btn cart-btn-logged relative" aria-label="Carrito de compras"
            (click)="toggleCart()">
            <div class="relative inline-block">
              <i class="fas fa-shopping-cart text-lg"></i>
              <span *ngIf="cartService.cartCount() > 0"
                class="absolute -top-2 -right-2 bg-[#ff0000] text-white text-[11px] font-bold h-[20px] min-w-[20px] flex items-center justify-center rounded-full border-[2px] border-white shadow-sm transform scale-100 transition-transform duration-200"
                style="color: #ffffff !important; background-color: #ff0000 !important;">
                {{ cartService.cartCount() }}
              </span>
            </div>
            <span class="ml-1 font-medium text-sm">Carrito</span>
          </button>
        </ng-container>

        <ng-template #guestActions>
          <div class="guest-actions">
            <!-- Botones de Sesión -->
            <div class="session-buttons">
              <a routerLink="/login" class="btn-login-header">Iniciar Sesión</a>
              <a routerLink="/register" class="btn-register-header">Registrarse</a>
            </div>

            <!-- Carrito Guest -->
            <button class="header-action-btn cart-btn-logged relative" aria-label="Carrito de compras"
              (click)="toggleCart()">
              <div class="relative inline-block">
                <i class="fas fa-shopping-cart text-lg"></i>
                <span *ngIf="cartService.cartCount() > 0"
                  class="absolute -top-2 -right-2 bg-[#ff0000] text-white text-[11px] font-bold h-[20px] min-w-[20px] flex items-center justify-center rounded-full border-[2px] border-white shadow-sm transform scale-100 transition-transform duration-200"
                  style="color: #ffffff !important; background-color: #ff0000 !important;">
                  {{ cartService.cartCount() }}
                </span>
              </div>
              <span class="ml-1 font-medium text-sm">Carrito</span>
            </button>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Navegación Principal (3 MEGAS) -->
  <nav class="header-navigation" aria-label="Navegación principal">
    <div class="header-container">
      <ul class="nav-list">
        <li class="nav-item">
          <a routerLink="/" class="nav-link active">
            <i class="fas fa-home"></i>
            <span>INICIO</span>
          </a>
        </li>

        <!-- MEGA 1: Papelería & Oficina -->
        <li class="nav-item mega-parent" (mouseenter)="openMega('papeleria')" (mouseleave)="scheduleCloseMega()"
          (mouseenter)="cancelCloseMega()">
          <a [routerLink]="['/products']" [queryParams]="{categoria: 'papeleria-oficina'}" class="nav-link"
            [class.active]="megaMenu() === 'papeleria'">
            <i class="fas fa-pen-nib"></i>
            <span>PAPELERÍA & OFICINA</span>
            <i class="fas fa-chevron-down arrow"></i>
          </a>
        </li>

        <!-- MEGA 2: Hogar & Lifestyle -->
        <li class="nav-item mega-parent" (mouseenter)="openMega('hogar')" (mouseleave)="scheduleCloseMega()"
          (mouseenter)="cancelCloseMega()">
          <a [routerLink]="['/products']" [queryParams]="{categoria: 'hogar-lifestyle'}" class="nav-link"
            [class.active]="megaMenu() === 'hogar'">
            <i class="fas fa-store"></i>
            <span>HOGAR & LIFESTYLE</span>
            <i class="fas fa-chevron-down arrow"></i>
          </a>
        </li>

        <!-- MEGA 3: Creatividad & Regalos -->
        <li class="nav-item mega-parent" (mouseenter)="openMega('creatividad')" (mouseleave)="scheduleCloseMega()"
          (mouseenter)="cancelCloseMega()">
          <a [routerLink]="['/products']" [queryParams]="{categoria: 'creatividad-regalos'}" class="nav-link"
            [class.active]="megaMenu() === 'creatividad'">
            <i class="fas fa-palette"></i>
            <span>CREATIVIDAD & REGALOS</span>
            <i class="fas fa-chevron-down arrow"></i>
          </a>
        </li>

        <li class="nav-item">
          <a [routerLink]="['/offers']" class="nav-link highlight">
            <i class="fas fa-tag"></i>
            <span>OFERTAS ESPECIALES</span>
          </a>
        </li>

        <li class="nav-item">
          <a [routerLink]="['/products']" [queryParams]="{sort: 'newest'}" class="nav-link">
            <i class="fas fa-star"></i>
            <span>NUEVO</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- MEGA MENÚS DESPLEGABLES -->
  <div class="mega-menu-container" (mouseenter)="cancelCloseMega()" (mouseleave)="scheduleCloseMega()">
    <!-- MEGA 1: Papelería & Oficina -->
    <div class="mega-menu" [class.active]="megaMenu() === 'papeleria'">
      <div class="mega-content">
        <div class="mega-grid" style="grid-template-columns: repeat(4, 1fr);">
          <!-- Columna 1: Escolar -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-graduation-cap"></i> ESCOLAR</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'utiles-escolares'}">Útiles escolares</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'cuadernos'}">Cuadernos</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'libretas'}">Libretas</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'forros'}">Forros</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'mochilas'}">Mochilas</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'cartucheras'}">Cartucheras</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'materiales-dibujo'}">Materiales de dibujo</a></li>
            </ul>
          </div>

          <!-- Columna 2: Oficina -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-briefcase"></i> OFICINA</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'suministros-oficina'}">Suministros de oficina</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'accesorios-oficina'}">Accesorios de oficina</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'carpetas'}">Carpetas</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'sellos'}">Sellos</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'papeleria-especializada'}">Papelería especializada</a></li>
            </ul>
          </div>

          <!-- Columna 3: Tecnología -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-calculator"></i> TECNOLOGÍA</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'calculadoras'}">Calculadoras</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'sumadoras'}">Sumadoras</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'tecnologia-oficina'}">Tecnología de oficina</a></li>
            </ul>
          </div>

          <!-- Columna 4: Papeles -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-scroll"></i> PAPELES</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'carton'}">Cartón</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'cartulina'}">Cartulina</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'papel-bond'}">Papel bond</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'papel-especial'}">Papel especial</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- MEGA 2: Hogar & Lifestyle -->
    <div class="mega-menu" [class.active]="megaMenu() === 'hogar'">
      <div class="mega-content">
        <div class="mega-grid" style="grid-template-columns: repeat(4, 1fr);">
          <!-- Columna 1 -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-home"></i> HOGAR & DECORACIÓN</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'decoracion'}">Decoración</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'electromenor'}">Electromenor</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'cocina'}">Cocina</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'organizacion-hogar'}">Organización del hogar</a></li>
            </ul>
          </div>

          <!-- Columna 2 -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-spa"></i> PERSONAL & BIENESTAR</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'aseo-personal'}">Aseo personal</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'cosmeticos'}">Cosméticos</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'accesorios-cabello'}">Accesorios de cabello</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'utiles-aseo'}">Útiles de aseo</a></li>
            </ul>
          </div>

          <!-- Columna 3 -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-tshirt"></i> MODA & ACCESORIOS</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'accesorios-moda'}">Accesorios de moda</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'bisuteria'}">Bisutería</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'bolsos'}">Bolsos</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'relojes'}">Relojes</a></li>
            </ul>
          </div>

          <!-- Columna 4 -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-dumbbell"></i> DEPORTES & GYM</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'articulos-deportivos'}">Artículos deportivos</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'gimnasio'}">Gimnasio</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- MEGA 3: Creatividad & Regalos -->
    <div class="mega-menu" [class.active]="megaMenu() === 'creatividad'">
      <div class="mega-content">
        <div class="mega-grid" style="grid-template-columns: repeat(3, 1fr);">
          <!-- Columna 1 -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-paint-brush"></i> ARTE & CREATIVIDAD</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'productos-arte'}">Productos de arte</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'pinturas'}">Pinturas</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'manualidades'}">Manualidades</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'arquitectura'}">Arquitectura</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'herramientas-creativas'}">Herramientas creativas</a></li>
            </ul>
          </div>

          <!-- Columna 2 -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-gift"></i> REGALOS & EVENTOS</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'regalos'}">Regalos</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'fiestas'}">Fiestas</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'cumpleanos'}">Cumpleaños</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'tarjeteria'}">Tarjetería</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'navidad'}">Navidad</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'embalaje-regalos'}">Embalaje para regalos</a></li>
            </ul>
          </div>

          <!-- Columna 3 -->
          <div class="mega-section">
            <h3 class="mega-title"><i class="fas fa-cookie"></i> COMIDA & SNACKS</h3>
            <ul class="mega-list">
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'comida'}">Comida</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'snacks'}">Snacks</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'dulces'}">Dulces</a></li>
              <li><a [routerLink]="['/products']" [queryParams]="{categoria: 'alimentos'}">Alimentos</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>