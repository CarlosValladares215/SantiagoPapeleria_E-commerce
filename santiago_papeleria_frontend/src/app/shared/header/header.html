<header class="header">

  <!-- TOP BAR -->
  <div class="header-top">

    <!-- Botón Hamburguesa (móvil) -->
    <button class="menu-toggle" type="button" (click)="toggleMobileMenu()"
      [attr.aria-label]="isMobileMenuOpen() ? 'Cerrar menú principal' : 'Abrir menú principal'">
      <i class="ri-menu-line" *ngIf="!isMobileMenuOpen()"></i>
      <i class="ri-close-line" *ngIf="isMobileMenuOpen()"></i>
    </button>

    <!-- LOGO -->
    <div class="logo">
      <a routerLink="/">
        <img src="assets/Logo_Grafica.png" alt="Logo Santiago Papelería" />
      </a>
    </div>

    <!-- SEARCH BOX -->
    <div class="search-box">
      <i class="ri-search-line search-icon"></i>
      <input type="text" placeholder="Buscar productos, marcas o categorías..." [(ngModel)]="searchQuery"
        (keyup.enter)="performSearch()" />
    </div>

    <!-- ACCIONES (tracking, carrito, auth) -->
    <div class="header-actions">

      <!-- Rastreo -->
      <a routerLink="/tracking" class="header-icon-action" title="Rastrear Pedido">
        <i class="ri-truck-line"></i>
      </a>

      <!-- Carrito -->
      <a routerLink="/checkout" class="header-icon-action cart-link" title="Carrito de Compras">
        <i class="ri-shopping-cart-line"></i>
        <span class="cart-badge" *ngIf="cartCount > 0">
          {{ cartCount }}
        </span>
      </a>

      <!-- NO AUTENTICADO (ESCRITORIO) -->
      <ng-container *ngIf="!auth.isAuthenticated(); else loggedInDesktop">
        <a routerLink="/login" class="btn btn-secondary desktop-only">
          Iniciar Sesión
        </a>

        <a routerLink="/register" class="btn btn-primary desktop-only">
          Registrarse
        </a>
      </ng-container>

      <!-- AUTENTICADO (ESCRITORIO) -->
      <ng-template #loggedInDesktop>
        <div class="profile-wrapper desktop-only">
          <button type="button" class="profile-trigger" (click)="toggleProfileMenu()">

            <!-- Avatar -->
            <div class="avatar">
              <span>
                {{ auth.user()?.name?.[0] | uppercase }}
              </span>
            </div>

            <!-- Nombre / tipo de cuenta -->
            <div class="profile-text">
              <p class="profile-name">
                {{ auth.user()?.name }}
              </p>
              <p class="profile-type">
                {{ auth.user()?.accountType }}
              </p>
            </div>

            <i class="ri-arrow-down-s-line profile-arrow" [class.rotate]="isProfileMenuOpen()">
            </i>
          </button>

          <!-- Dropdown perfil -->
          <div class="profile-menu" *ngIf="isProfileMenuOpen()">

            <div class="profile-menu-header">
              <p class="profile-menu-name">
                {{ auth.user()?.name }}
              </p>
              <p class="profile-menu-email">
                {{ auth.user()?.email }}
              </p>
              <span class="profile-menu-tag">
                {{ auth.user()?.accountType }}
              </span>
            </div>

            <div class="profile-menu-body">
              <a routerLink="/profile" (click)="onNavLinkClick()" class="profile-menu-item">
                <i class="ri-user-line"></i>
                <span>Mi Perfil</span>
              </a>
            </div>

            <div class="profile-menu-footer">
              <button type="button" (click)="logout()" class="profile-menu-item logout">
                <i class="ri-logout-box-line"></i>
                <span>Cerrar Sesión</span>
              </button>
            </div>
          </div>
        </div>
      </ng-template>

    </div>
  </div>

  <!-- NAVBAR (ESCRITORIO + MÓVIL) -->
  <div class="header-bottom">
    <nav class="main-nav" [class.open]="isMobileMenuOpen()">

      <div class="nav-container">
        <ul>
          <li>
            <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}"
              (click)="onNavLinkClick()">
              INICIO
            </a>
          </li>

          <li>
            <a routerLink="/products" routerLinkActive="active" (click)="onNavLinkClick()">
              PRODUCTOS
            </a>
          </li>

          <li (mouseenter)="openMega('bazar')" (mouseleave)="scheduleCloseMega()">
            <a routerLink="/bazar" routerLinkActive="active" (click)="onNavLinkClick()">
              BAZAR
            </a>
          </li>

          <li (mouseenter)="openMega('papeleria')" (mouseleave)="scheduleCloseMega()">
            <a routerLink="/papeleria" routerLinkActive="active" (click)="onNavLinkClick()">
              PAPELERÍA
            </a>
          </li>

          <li>
            <a routerLink="/oficina" routerLinkActive="active" (click)="onNavLinkClick()">
              OFICINA
            </a>
          </li>

          <li>
            <a routerLink="/offers" routerLinkActive="active" (click)="onNavLinkClick()">
              PROMOCIONES
            </a>
          </li>

          <li>
            <a routerLink="/contact" routerLinkActive="active" (click)="onNavLinkClick()">
              CONTACTO
            </a>
          </li>
        </ul>
      </div>

      <!-- ACCIONES DENTRO DEL MENÚ MÓVIL -->
      <div class="mobile-actions">
        <!-- NO AUTENTICADO (MÓVIL) -->
        <ng-container *ngIf="!auth.isAuthenticated(); else mobileLoggedIn">
          <a routerLink="/login" class="btn btn-secondary" (click)="onNavLinkClick()">
            Iniciar Sesión
          </a>
          <a routerLink="/register" class="btn btn-primary" (click)="onNavLinkClick()">
            Registrarse
          </a>
        </ng-container>

        <!-- AUTENTICADO (MÓVIL) -->
        <ng-template #mobileLoggedIn>
          <button type="button" class="btn btn-secondary" (click)="goToProfile()">
            Mi Perfil
          </button>
          <button type="button" class="btn btn-primary" (click)="logout()">
            Cerrar Sesión
          </button>
        </ng-template>
      </div>

    </nav>
  </div>
</header>

<!-- MEGA MENÚ BAZAR -->
<div class="mega-menu" [class.show]="megaMenu() === 'bazar'" (mouseenter)="cancelCloseMega()"
  (mouseleave)="scheduleCloseMega()">

  <div class="mega-container">
    <div class="mega-col">
      <div class="mega-title">Accesorios</div>
      <a class="mega-item" routerLink="/bazar/bisuteria">
        <i class="ri-gem-line"></i>
        <span>Bisutería</span>
      </a>
      <a class="mega-item" routerLink="/bazar/bolsos">
        <i class="ri-handbag-line"></i>
        <span>Bolsos</span>
      </a>
    </div>

    <div class="mega-col">
      <div class="mega-title">Hogar & Familia</div>
      <a class="mega-item" routerLink="/bazar/hogar">
        <i class="ri-home-4-line"></i>
        <span>Hogar</span>
      </a>
      <a class="mega-item" routerLink="/bazar/navidad">
        <i class="ri-tree-line"></i>
        <span>Navidad</span>
      </a>
      <a class="mega-item" routerLink="/bazar/comida">
        <i class="ri-restaurant-line"></i>
        <span>Comida</span>
      </a>
    </div>
  </div>
</div>

<!-- MEGA MENÚ PAPELERÍA -->
<div class="mega-menu" [class.show]="megaMenu() === 'papeleria'" (mouseenter)="cancelCloseMega()"
  (mouseleave)="scheduleCloseMega()">

  <div class="mega-container">
    <div class="mega-col">
      <div class="mega-title">Papelería</div>
      <a class="mega-item" routerLink="/papeleria/carton">
        <i class="ri-square-line"></i>
        <span>Cartón</span>
      </a>
      <a class="mega-item" routerLink="/papeleria/cartulina">
        <i class="ri-file-copy-line"></i>
        <span>Cartulina</span>
      </a>
      <a class="mega-item" routerLink="/papeleria/papel">
        <i class="ri-attachment-2"></i>
        <span>Papel</span>
      </a>
    </div>

    <div class="mega-col">
      <div class="mega-title">Productos de Arte</div>
      <a class="mega-item" routerLink="/papeleria/arquitectura">
        <i class="ri-compasses-2-line"></i>
        <span>Arquitectura</span>
      </a>
      <a class="mega-item" routerLink="/papeleria/manualidades">
        <i class="ri-scissors-2-line"></i>
        <span>Manualidades</span>
      </a>
      <a class="mega-item" routerLink="/papeleria/pinturas">
        <i class="ri-paint-brush-line"></i>
        <span>Pinturas</span>
      </a>
    </div>

    <div class="mega-col">
      <div class="mega-title">Útiles Escolares</div>
      <a class="mega-item" routerLink="/papeleria/utiles-escolares">
        <i class="ri-book-2-line"></i>
        <span>Útiles Escolares</span>
      </a>
    </div>
  </div>
</div>