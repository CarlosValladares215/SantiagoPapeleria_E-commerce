<div class="min-h-screen bg-gray-50/50 p-6 md:p-8 animate-in fade-in duration-500">

    <!-- Header -->
    <div class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Configuración de Envíos</h1>
            <p class="text-slate-500 mt-1">Gestiona tarifas, zonas de entrega y reglas de envío.</p>
        </div>

        <!-- Toast -->
        @if (toast()) {
        <div class="px-4 py-2 rounded-lg shadow-lg text-sm font-medium animate-in slide-in-from-top-2"
            [class.bg-green-100]="toast()?.type === 'success'" [class.text-green-800]="toast()?.type === 'success'"
            [class.bg-red-100]="toast()?.type === 'error'" [class.text-red-800]="toast()?.type === 'error'">
            {{ toast()?.msg }}
        </div>
        }
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- Sidebar / Tabs -->
        <div class="lg:col-span-3 space-y-2">
            <button (click)="switchTab('general')"
                class="w-full text-left px-4 py-3 rounded-xl font-medium transition-all flex items-center gap-3"
                [class.bg-white]="currentTab() === 'general'" [class.shadow-sm]="currentTab() === 'general'"
                [class.text-blue-600]="currentTab() === 'general'" [class.text-slate-600]="currentTab() !== 'general'"
                [class.hover:bg-white/60]="currentTab() !== 'general'">
                <lucide-icon name="settings" class="w-5 h-5"></lucide-icon> General
            </button>
            <button (click)="switchTab('zones')"
                class="w-full text-left px-4 py-3 rounded-xl font-medium transition-all flex items-center gap-3"
                [class.bg-white]="currentTab() === 'zones'" [class.shadow-sm]="currentTab() === 'zones'"
                [class.text-blue-600]="currentTab() === 'zones'" [class.text-slate-600]="currentTab() !== 'zones'"
                [class.hover:bg-white/60]="currentTab() !== 'zones'">
                <lucide-icon name="map" class="w-5 h-5"></lucide-icon> Zonas y Tarifas
            </button>
            <button (click)="switchTab('import')"
                class="w-full text-left px-4 py-3 rounded-xl font-medium transition-all flex items-center gap-3"
                [class.bg-white]="currentTab() === 'import'" [class.shadow-sm]="currentTab() === 'import'"
                [class.text-blue-600]="currentTab() === 'import'" [class.text-slate-600]="currentTab() !== 'import'"
                [class.hover:bg-white/60]="currentTab() !== 'import'">
                <lucide-icon name="upload" class="w-5 h-5"></lucide-icon> Importar / Exportar
            </button>
        </div>

        <!-- Content Area -->
        <div class="lg:col-span-9">

            @if (isLoading()) {
            <div
                class="bg-white rounded-2xl shadow-sm border border-slate-200 p-12 flex flex-col items-center justify-center space-y-4 animate-pulse">
                <div class="w-12 h-12 bg-slate-200 rounded-full"></div>
                <div class="h-4 w-48 bg-slate-200 rounded"></div>
                <div class="h-4 w-32 bg-slate-200 rounded"></div>
            </div>
            } @else {

            <!-- TAB: GENERAL -->
            @if (currentTab() === 'general') {
            <div
                class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 space-y-8 animate-in zoom-in-95 duration-300">
                <div class="flex items-center justify-between pb-6 border-b border-slate-100">
                    <h2 class="text-xl font-bold text-slate-800">Reglas Globales</h2>
                    <button (click)="saveConfig()" [disabled]="isSaving()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-medium transition-all shadow-lg shadow-blue-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <lucide-icon name="save" class="w-4 h-4"></lucide-icon>
                        {{ isSaving() ? 'Guardando...' : 'Guardar Cambios' }}
                    </button>
                </div>

                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Impuesto
                            (IVA)</label>
                        <div class="relative">
                            <input type="number" min="0" [ngModel]="ivaPercentage()"
                                (ngModelChange)="updateIvaPercentage($event)"
                                class="w-full pl-4 pr-10 py-3 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none font-mono text-slate-700">
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">%</span>
                        </div>
                        <p class="text-xs text-slate-400 mt-2">Ingrese el valor entero (ej: 15)</p>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-green-500 uppercase tracking-wider mb-2">Envío Gratis
                            Desde</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                            <input type="number" min="0" [ngModel]="config().freeShippingThreshold"
                                (ngModelChange)="updateConfigField('freeShippingThreshold', $event)"
                                class="w-full pl-8 pr-4 py-3 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-green-100 focus:border-green-500 outline-none font-mono text-slate-700">
                        </div>
                        <p class="text-xs text-slate-400 mt-2">0 para desactivar</p>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Tarifa Base
                            (Global)</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                            <input type="number" min="0" [ngModel]="config().baseRate"
                                (ngModelChange)="updateConfigField('baseRate', $event)"
                                class="w-full pl-8 pr-4 py-3 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none font-mono text-slate-700">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Tarifa por
                            Kg (Global)</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                            <input type="number" min="0" [ngModel]="config().ratePerKg"
                                (ngModelChange)="updateConfigField('ratePerKg', $event)"
                                class="w-full pl-8 pr-4 py-3 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-100 focus:border-blue-500 outline-none font-mono text-slate-700">
                        </div>
                    </div>
                </div>
            </div>
            }

            <!-- TAB: ZONES -->
            @if (currentTab() === 'zones') {
            <div class="space-y-6 animate-in zoom-in-95 duration-300">

                <!-- Zone Creator (Map Visual) -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <lucide-icon name="map-pin" class="w-5 h-5 text-blue-500"></lucide-icon>
                        Nueva Zona Geográfica
                    </h2>

                    <div class="mb-6">
                        <input placeholder="Nombre de la Zona (Ej: Costa Norte)" [(ngModel)]="newZoneName"
                            class="w-full text-lg font-medium p-3 border-b-2 border-slate-200 focus:border-blue-500 outline-none bg-transparent placeholder-slate-300">
                    </div>

                    <!-- VISUAL MAP / GRID -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <!-- Costa -->
                        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                            <h3 class="text-xs font-bold text-blue-800 uppercase mb-3 text-center">Costa</h3>
                            <div class="flex flex-col gap-2">
                                @for(prov of regions.COSTA; track $index) {
                                <button (click)="toggleProvinceSelection(prov)"
                                    class="px-3 py-2 rounded-lg text-sm text-left transition-all flex justify-between items-center"
                                    [class.bg-blue-500]="selectedProvinces().has(prov)"
                                    [class.text-white]="selectedProvinces().has(prov)"
                                    [class.bg-white]="!selectedProvinces().has(prov)"
                                    [class.text-slate-600]="!selectedProvinces().has(prov)"
                                    [class.hover:bg-blue-100]="!selectedProvinces().has(prov)">
                                    {{ prov }}
                                    @if(selectedProvinces().has(prov)) { <lucide-icon name="check"
                                        class="w-3 h-3"></lucide-icon> }
                                </button>
                                }
                            </div>
                        </div>

                        <!-- Sierra -->
                        <div class="bg-amber-50/50 p-4 rounded-xl border border-amber-100 md:col-span-2">
                            <h3 class="text-xs font-bold text-amber-800 uppercase mb-3 text-center">Sierra</h3>
                            <div class="grid grid-cols-2 gap-2">
                                @for(prov of regions.SIERRA; track $index) {
                                <button (click)="toggleProvinceSelection(prov)"
                                    class="px-3 py-2 rounded-lg text-sm text-left transition-all flex justify-between items-center"
                                    [class.bg-amber-600]="selectedProvinces().has(prov)"
                                    [class.text-white]="selectedProvinces().has(prov)"
                                    [class.bg-white]="!selectedProvinces().has(prov)"
                                    [class.text-slate-600]="!selectedProvinces().has(prov)"
                                    [class.hover:bg-amber-100]="!selectedProvinces().has(prov)">
                                    {{ prov }}
                                    @if(selectedProvinces().has(prov)) { <lucide-icon name="check"
                                        class="w-3 h-3"></lucide-icon> }
                                </button>
                                }
                            </div>
                        </div>

                        <!-- Oriente & Insular -->
                        <div class="bg-emerald-50/50 p-4 rounded-xl border border-emerald-100">
                            <h3 class="text-xs font-bold text-emerald-800 uppercase mb-3 text-center">Oriente e Insular
                            </h3>
                            <div class="flex flex-col gap-2">
                                @for(prov of regions.ORIENTE; track $index) {
                                <button (click)="toggleProvinceSelection(prov)"
                                    class="px-3 py-2 rounded-lg text-sm text-left transition-all flex justify-between items-center"
                                    [class.bg-emerald-600]="selectedProvinces().has(prov)"
                                    [class.text-white]="selectedProvinces().has(prov)"
                                    [class.bg-white]="!selectedProvinces().has(prov)"
                                    [class.text-slate-600]="!selectedProvinces().has(prov)"
                                    [class.hover:bg-emerald-100]="!selectedProvinces().has(prov)">
                                    {{ prov }}
                                    @if(selectedProvinces().has(prov)) { <lucide-icon name="check"
                                        class="w-3 h-3"></lucide-icon> }
                                </button>
                                }
                                <div class="my-2 border-t border-emerald-200"></div>
                                @for(prov of regions.INSULAR; track $index) {
                                <button (click)="toggleProvinceSelection(prov)"
                                    class="px-3 py-2 rounded-lg text-sm text-left transition-all flex justify-between items-center"
                                    [class.bg-indigo-600]="selectedProvinces().has(prov)"
                                    [class.text-white]="selectedProvinces().has(prov)"
                                    [class.bg-white]="!selectedProvinces().has(prov)"
                                    [class.text-slate-600]="!selectedProvinces().has(prov)"
                                    [class.hover:bg-indigo-100]="!selectedProvinces().has(prov)">
                                    {{ prov }}
                                    @if(selectedProvinces().has(prov)) { <lucide-icon name="check"
                                        class="w-3 h-3"></lucide-icon> }
                                </button>
                                }
                            </div>
                        </div>
                    </div>

                    <button (click)="createZone()"
                        class="w-full py-3 bg-slate-900 text-white rounded-xl font-medium hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                        Crear Zona
                    </button>
                </div>

                <!-- Existing Zones List -->
                <div class="grid md:grid-cols-2 gap-6">
                    @for(zone of zones(); track (zone._id || zone.name)) {
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden cursor-pointer transition-all hover:shadow-md hover:border-blue-200"
                        [class.ring-2]="selectedZone()?._id === zone._id"
                        [class.ring-blue-500]="selectedZone()?._id === zone._id" (click)="selectZone(zone)">
                        <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800">{{ zone.name }}</h3>
                            <button (click)="deleteZone(zone._id); $event.stopPropagation()"
                                class="text-slate-400 hover:text-red-500">
                                <lucide-icon name="trash-2" class="w-4 h-4"></lucide-icon>
                            </button>
                        </div>
                        <div class="p-4">
                            <div class="flex flex-wrap gap-1 mb-4">
                                @for(p of zone.provinces.slice(0, 5); track $index) {
                                <span
                                    class="text-xs bg-white border border-slate-200 px-2 py-0.5 rounded text-slate-500">{{
                                    p }}</span>
                                }
                                @if(zone.provinces.length > 5) {
                                <span class="text-xs text-slate-400 px-1">+{{ zone.provinces.length - 5 }} más</span>
                                }
                            </div>

                            <!-- Selected Zone Details (Rates) -->
                            @if(selectedZone()?._id === zone._id) {
                            <div class="mt-4 pt-4 border-t border-slate-100 animate-in slide-in-from-top-2">
                                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Tarifas por
                                    Peso (Kg)</h4>

                                <div class="space-y-2 mb-4">
                                    @for(rate of rates(); track (rate._id || $index)) {
                                    <div class="flex items-center gap-2 text-sm">
                                        <div
                                            class="flex-1 bg-slate-100 rounded px-2 py-1 text-slate-600 font-mono text-xs">
                                            {{ rate.min_weight }} - {{ rate.max_weight }} kg
                                        </div>
                                        <input type="number" min="0" [(ngModel)]="rate.price"
                                            (change)="updateRate(rate)"
                                            class="w-20 px-2 py-1 border rounded text-right font-medium text-slate-800 focus:border-blue-500 outline-none">
                                        <span class="text-slate-400 text-xs">$</span>
                                        <button (click)="deleteRate(rate._id)"
                                            class="text-slate-300 hover:text-red-500 p-1">
                                            <lucide-icon name="x" class="w-3 h-3"></lucide-icon>
                                        </button>
                                    </div>
                                    }
                                </div>

                                <div
                                    class="flex gap-2 items-center bg-blue-50/50 p-2 rounded-lg border border-blue-100">
                                    <input type="number" min="0" [ngModel]="newRateMin()"
                                        (ngModelChange)="newRateMin.set($event)"
                                        class="w-16 px-2 py-1 rounded border text-xs text-center" placeholder="Min">
                                    <span class="text-slate-400">-</span>
                                    <input type="number" min="0" [ngModel]="newRateMax()"
                                        (ngModelChange)="newRateMax.set($event)"
                                        class="w-16 px-2 py-1 rounded border text-xs text-center" placeholder="Max">
                                    <span class="text-slate-400">=</span>
                                    <div class="relative flex-1">
                                        <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs">$</span>
                                        <input type="number" min="0" [ngModel]="newRatePrice()"
                                            (ngModelChange)="newRatePrice.set($event)"
                                            class="w-full pl-5 px-2 py-1 rounded border text-xs font-bold"
                                            placeholder="Precio">
                                    </div>
                                    <button (click)="addRate()"
                                        class="p-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        <lucide-icon name="plus" class="w-4 h-4"></lucide-icon>
                                    </button>
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                    }
                </div>
            </div>
            }

            <!-- TAB: IMPORT -->
            @if (currentTab() === 'import') {
            <div
                class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 text-center space-y-6 animate-in zoom-in-95 duration-300">
                <div
                    class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <lucide-icon name="file-spreadsheet" class="w-10 h-10"></lucide-icon>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Importación Masiva</h3>
                <p class="text-slate-500 max-w-md mx-auto">Sube un archivo Excel (.xlsx) o CSV para actualizar zonas y
                    tarifas rápidamente.</p>

                <div class="flex justify-center gap-4">
                    <label
                        class="cursor-pointer bg-slate-900 hover:bg-slate-800 text-white px-6 py-3 rounded-xl font-medium transition-all shadow-lg shadow-slate-200 flex items-center gap-2">
                        <lucide-icon name="upload-cloud" class="w-5 h-5"></lucide-icon>
                        Seleccionar Archivo
                        <input type="file" (change)="onFileSelected($event)" accept=".xlsx, .csv" class="hidden">
                    </label>
                </div>
            </div>
            }
            }

        </div>
    </div>
</div>