<div class="space-y-6 animate-in zoom-in-95 duration-300">

    <!-- Zone Creator (Map Visual) -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <div class="flex items-center gap-3 mb-6">
            <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                <lucide-icon name="map-pin" class="w-6 h-6"></lucide-icon>
            </div>
            <h2 class="text-xl font-bold text-slate-800">Nueva Zona Geográfica</h2>
        </div>

        <div class="mb-6">
            <input placeholder="Nombre de la Zona (Ej: Costa Norte)" [ngModel]="newZoneName()"
                (ngModelChange)="newZoneName.set($event)" maxlength="30"
                class="w-full text-lg font-medium p-3 border-b-2 border-slate-200 focus:border-blue-500 outline-none bg-transparent placeholder-slate-300">
            <p class="text-xs text-slate-400 mt-1 text-right">{{ newZoneName().length }}/30</p>
        </div>

        <!-- VISUAL MAP / GRID -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <app-zone-region-selector title="Costa" [provinces]="regions['COSTA']" color="blue"
                [selected]="selectedProvinces()" (toggle)="toggleProvince($event)"></app-zone-region-selector>
            <app-zone-region-selector title="Sierra" [provinces]="regions['SIERRA']" color="amber"
                [selected]="selectedProvinces()" (toggle)="toggleProvince($event)"
                class="md:col-span-2"></app-zone-region-selector>

            <div class="flex flex-col gap-6">
                <app-zone-region-selector title="Oriente" [provinces]="regions['ORIENTE']" color="emerald"
                    [selected]="selectedProvinces()" (toggle)="toggleProvince($event)"></app-zone-region-selector>
                <app-zone-region-selector title="Insular" [provinces]="regions['INSULAR']" color="indigo"
                    [selected]="selectedProvinces()" (toggle)="toggleProvince($event)"></app-zone-region-selector>
            </div>
        </div>

        <button (click)="createZone()" [disabled]="!newZoneName() || selectedProvinces().size === 0"
            class="w-full py-3 bg-slate-900 text-white rounded-xl font-medium hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200 disabled:opacity-50 disabled:cursor-not-allowed">
            Crear Zona {{ selectedProvinces().size > 0 ? '(' + selectedProvinces().size + ')' : '' }}
        </button>
    </div>

    <!-- Existing Zones List -->
    <div class="grid md:grid-cols-2 gap-6">
        @for(zone of state.zones(); track (zone._id || zone.name)) {
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden cursor-pointer transition-all hover:shadow-md hover:border-blue-200"
            [class.ring-2]="state.selectedZone()?._id === zone._id"
            [class.ring-blue-500]="state.selectedZone()?._id === zone._id" (click)="selectZone(zone)">
            <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">{{ zone.name }}</h3>
                <button (click)="deleteZone(zone._id); $event.stopPropagation()"
                    class="text-slate-400 hover:text-red-500">
                    <lucide-icon name="trash-2" class="w-4 h-4"></lucide-icon>
                </button>
            </div>
            <div class="p-4">
                <div class="flex flex-wrap gap-1 mb-4">
                    @for(p of zone.provinces.slice(0, 5); track $index) {
                    <span class="text-xs bg-white border border-slate-200 px-2 py-0.5 rounded text-slate-500">{{
                        p }}</span>
                    }
                    @if(zone.provinces.length > 5) {
                    <span class="text-xs text-slate-400 px-1">+{{ zone.provinces.length - 5 }} más</span>
                    }
                </div>

                <!-- Selected Zone Details (Rates) -->
                @if(state.selectedZone()?._id === zone._id) {
                <div class="mt-4 pt-4 border-t border-slate-100 animate-in slide-in-from-top-2"
                    (click)="$event.stopPropagation()">

                    <!-- New Multiplier Config -->
                    <div class="mb-4 bg-indigo-50/50 rounded-lg p-3 border border-indigo-100">
                        <label class="text-xs font-bold text-indigo-800 uppercase tracking-wider mb-1 block">Costo por
                            Km</label>
                        <div class="flex items-center gap-2">
                            <span class="text-indigo-500 font-bold">$</span>
                            <input type="number" step="0.01" min="0" [(ngModel)]="zone.multiplier"
                                (change)="updateZoneSettings(zone)"
                                class="w-24 bg-white border border-indigo-200 rounded px-2 py-1 text-sm font-bold text-indigo-900 focus:ring-2 focus:ring-indigo-500 outline-none">
                            <span class="text-xs text-indigo-500">/ km de distancia</span>
                        </div>
                        <p class="text-[10px] text-indigo-400 mt-1">Se multiplica por la distancia de la ciudad destino.
                        </p>
                    </div>

                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Tarifa Base por Peso (Kg)
                    </h4>
                    <p class="text-[10px] text-slate-400 mb-2">Se suma al costo por distancia.</p>

                    <div class="space-y-2 mb-4">
                        @for(rate of state.rates(); track (rate._id || $index)) {
                        <div class="flex items-center gap-2 text-sm">
                            <div class="flex items-center bg-slate-100 rounded px-1 py-1 gap-1 relative group">
                                <input type="number" min="0" max="999999" [(ngModel)]="rate.min_weight"
                                    (change)="updateRate(rate)"
                                    class="w-12 bg-transparent text-center border-b border-slate-300 focus:border-blue-500 outline-none text-xs font-mono"
                                    placeholder="0">
                                <span class="text-slate-400">-</span>

                                <div class="relative w-12 flex justify-center">
                                    @if(rate.max_weight >= 999999) {
                                    <div class="text-lg leading-none cursor-pointer text-slate-600"
                                        (click)="rate.max_weight = rate.min_weight + 1; updateRate(rate)"
                                        title="Click para definir límite">∞</div>
                                    } @else {
                                    <input type="number" min="0" max="999999" [(ngModel)]="rate.max_weight"
                                        (change)="updateRate(rate)"
                                        class="w-12 bg-transparent text-center border-b border-slate-300 focus:border-blue-500 outline-none text-xs font-mono"
                                        placeholder="0">
                                    }
                                </div>

                                <button
                                    class="ml-1 text-slate-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                    (click)="rate.max_weight = (rate.max_weight >= 999999 ? rate.min_weight + 1 : 999999); updateRate(rate)"
                                    [title]="rate.max_weight >= 999999 ? 'Definir límite' : 'Sin límite (∞)'">
                                    <lucide-icon [name]="rate.max_weight >= 999999 ? 'minimize-2' : 'infinity'"
                                        class="w-3 h-3"></lucide-icon>
                                </button>

                                <span class="text-slate-500 text-[10px] ml-1">kg</span>
                            </div>

                            <input type="number" min="0" max="9999" [(ngModel)]="rate.price" (change)="updateRate(rate)"
                                (keydown)="preventSymbols($event)" (blur)="formatRatePrice(rate)"
                                class="w-20 px-2 py-1 border rounded text-right font-medium text-slate-800 focus:border-blue-500 outline-none">
                            <span class="text-slate-400 text-xs">$</span>
                            <button (click)="deleteRate(rate._id)" class="text-slate-300 hover:text-red-500 p-1">
                                <lucide-icon name="x" class="w-3 h-3"></lucide-icon>
                            </button>
                        </div>
                        }
                    </div>

                    <div class="flex gap-2 items-center bg-blue-50/50 p-2 rounded-lg border border-blue-100"
                        (click)="$event.stopPropagation()">
                        <input type="number" min="0" max="999" [ngModel]="newRateMin()"
                            (ngModelChange)="newRateMin.set($event)" (keydown)="preventSymbols($event)"
                            oninput="if(this.value.length > 4) this.value = this.value.slice(0,4)"
                            class="w-16 px-2 py-1 rounded border text-xs text-center" placeholder="Min">
                        <span class="text-slate-400">-</span>

                        <div class="relative flex items-center">
                            @if(newRateMax() >= 999999) {
                            <div class="w-16 h-7 flex items-center justify-center bg-white border border-slate-200 rounded text-slate-600 cursor-pointer"
                                (click)="newRateMax.set(newRateMin() + 1)" title="Click para definir límite">
                                <span class="text-lg leading-none">∞</span>
                            </div>
                            } @else {
                            <input type="number" min="0" max="999999" [ngModel]="newRateMax()"
                                (ngModelChange)="newRateMax.set($event)" (keydown)="preventSymbols($event)"
                                oninput="if(this.value.length > 4) this.value = this.value.slice(0,4)"
                                class="w-16 px-2 py-1 rounded border text-xs text-center" placeholder="Max">
                            }
                            <button class="absolute -right-6 text-slate-400 hover:text-blue-600"
                                (click)="newRateMax.set(newRateMax() >= 999999 ? newRateMin() + 1 : 999999)"
                                [title]="newRateMax() >= 999999 ? 'Definir límite' : 'Sin límite (∞)'">
                                <lucide-icon [name]="newRateMax() >= 999999 ? 'minimize-2' : 'infinity'"
                                    class="w-4 h-4"></lucide-icon>
                            </button>
                        </div>

                        <span class="text-slate-400 ml-4">=</span>
                        <div class="relative flex-1">
                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs">$</span>
                            <input type="number" min="0" max="9999" [ngModel]="newRatePrice()"
                                (ngModelChange)="newRatePrice.set($event)" (keydown)="preventSymbols($event)"
                                (blur)="formatNewRatePrice()"
                                class="w-full pl-5 px-2 py-1 rounded border text-xs font-bold" placeholder="Precio">
                        </div>
                        <button (click)="addRate()" class="p-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <lucide-icon name="plus" class="w-4 h-4"></lucide-icon>
                        </button>
                    </div>
                </div>
                }
            </div>
        </div>
        }
    </div>