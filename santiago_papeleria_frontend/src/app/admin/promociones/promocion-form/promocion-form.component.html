<div class="p-6 bg-gray-50 min-h-screen flex justify-center">
    <div class="w-full max-w-4xl bg-white rounded-lg shadow-lg p-8">
        <div class="flex items-center mb-6 gap-4">
            <button routerLink="/admin/promociones" class="text-gray-500 hover:text-gray-700 transition-colors">
                <i class="ri-arrow-left-line text-2xl"></i>
            </button>
            <h1 class="text-2xl font-bold text-gray-800">{{ isEdit ? 'Editar' : 'Nueva' }} Promoción</h1>
        </div>

        <form [formGroup]="form" (ngSubmit)="save()" class="space-y-6">

            <!-- Basic Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                    <input formControlName="nombre" type="text"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2"
                        placeholder="Ej: Black Friday 2026">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción (Opcional)</label>
                    <input formControlName="descripcion" type="text"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                </div>
            </div>

            <!-- Type & Value -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50 p-4 rounded-md">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Descuento</label>
                    <select formControlName="tipo"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                        <option value="porcentaje">Porcentaje (%)</option>
                        <option value="valor_fijo">Valor Fijo ($)</option>
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor</label>
                    <input formControlName="valor" type="number" step="0.01"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                </div>
                <div class="flex items-center pt-6">
                    <label class="flex items-center">
                        <input formControlName="activa" type="checkbox"
                            class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <span class="ml-2 text-sm text-gray-600 font-bold">Promoción Activa</span>
                    </label>
                </div>
            </div>

            <!-- Multi-Select Filters -->
            <div class="border-t pt-4">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    Alcance <span class="text-sm font-normal text-gray-500">(Selecciona uno o más criterios)</span>
                </h3>

                <div class="space-y-6">

                    <!-- Categories Section -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <label class="block text-sm font-semibold text-blue-800 mb-2">
                            <i class="ri-folder-line mr-1"></i> Categorías
                        </label>
                        <div class="flex gap-2 mb-3">
                            <select #categorySelect
                                class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2 bg-white">
                                <option value="" disabled selected>Selecciona una categoría...</option>
                                <option *ngFor="let cat of allGroups" [value]="cat">{{ cat }}</option>
                            </select>
                            <button type="button" (click)="addCategory(categorySelect.value); categorySelect.value=''"
                                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                <i class="ri-add-line"></i> Agregar
                            </button>
                        </div>

                        <!-- Selected Categories Chips -->
                        <div *ngIf="selectedCategories.length > 0" class="flex flex-wrap gap-2">
                            <div *ngFor="let cat of selectedCategories; let i = index"
                                class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2">
                                <span>{{ cat }}</span>
                                <button type="button" (click)="removeCategory(i)" class="hover:text-red-200">
                                    <i class="ri-close-line"></i>
                                </button>
                            </div>
                        </div>
                        <p *ngIf="selectedCategories.length === 0" class="text-sm text-gray-500 italic">
                            No hay categorías seleccionadas
                        </p>
                    </div>

                    <!-- Brands Section -->
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <label class="block text-sm font-semibold text-purple-800 mb-2">
                            <i class="ri-price-tag-3-line mr-1"></i> Marcas
                        </label>
                        <div class="flex gap-2 mb-3">
                            <select #brandSelect
                                class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 border p-2 bg-white">
                                <option value="" disabled selected>Selecciona una marca...</option>
                                <option *ngFor="let brand of brands" [value]="brand">{{ brand }}</option>
                            </select>
                            <button type="button" (click)="addBrand(brandSelect.value); brandSelect.value=''"
                                class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                                <i class="ri-add-line"></i> Agregar
                            </button>
                        </div>

                        <!-- Selected Brands Chips -->
                        <div *ngIf="selectedBrands.length > 0" class="flex flex-wrap gap-2">
                            <div *ngFor="let brand of selectedBrands; let i = index"
                                class="bg-purple-600 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2">
                                <span>{{ brand }}</span>
                                <button type="button" (click)="removeBrand(i)" class="hover:text-red-200">
                                    <i class="ri-close-line"></i>
                                </button>
                            </div>
                        </div>
                        <p *ngIf="selectedBrands.length === 0" class="text-sm text-gray-500 italic">
                            No hay marcas seleccionadas
                        </p>
                    </div>

                    <!-- Products Section -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <label class="block text-sm font-semibold text-green-800 mb-2">
                            <i class="ri-shopping-bag-line mr-1"></i> Productos Específicos
                        </label>

                        <!-- Product Search -->
                        <div class="relative mb-3">
                            <i class="ri-search-line absolute left-3 top-2.5 text-gray-400"></i>
                            <input [formControl]="searchControl" type="text" placeholder="Buscar por nombre o código..."
                                (keydown.enter)="handleSearchEnter($event)"
                                class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 bg-white">

                            <!-- Loading Indicator -->
                            <div *ngIf="isSearching" class="absolute right-3 top-2.5">
                                <i class="ri-loader-4-line animate-spin text-green-500"></i>
                            </div>

                            <!-- Search Results Dropdown -->
                            <div *ngIf="searchResults.length > 0"
                                class="absolute z-10 w-full bg-white shadow-lg rounded-md mt-1 border border-gray-100 max-h-60 overflow-y-auto">
                                <ul>
                                    <li *ngFor="let product of searchResults" (click)="addProduct(product)"
                                        class="px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center gap-3 border-b border-gray-50 last:border-0">
                                        <img [src]="product.multimedia?.principal"
                                            class="w-8 h-8 rounded object-cover bg-gray-100" alt="">
                                        <div class="flex-1">
                                            <div class="text-sm font-medium text-gray-800">{{ product.nombre }}</div>
                                            <div class="text-xs text-gray-500">SKU: {{ product.codigo_interno }}</div>
                                        </div>
                                        <i class="ri-add-circle-line text-green-500"></i>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Selected Products List -->
                        <div *ngIf="selectedProducts.length > 0" class="space-y-2">
                            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                Productos Seleccionados ({{ selectedProducts.length }})
                            </div>
                            <div class="border rounded-md divide-y divide-gray-100 max-h-48 overflow-y-auto bg-white">
                                <div *ngFor="let item of selectedProducts; let i = index"
                                    class="flex items-center justify-between p-2 hover:bg-gray-50">
                                    <div class="flex items-center gap-3 overflow-hidden">
                                        <img [src]="item.multimedia?.principal"
                                            class="w-8 h-8 rounded object-cover bg-gray-100" alt="">
                                        <div class="min-w-0">
                                            <div class="text-sm font-medium text-gray-800 truncate">{{ item.nombre }}
                                            </div>
                                            <div class="text-xs text-gray-500">{{ item.codigo_interno }}</div>
                                        </div>
                                    </div>
                                    <button type="button" (click)="removeProduct(i)"
                                        class="text-red-500 hover:text-red-700 p-1 hover:bg-red-50 rounded">
                                        <i class="ri-delete-bin-line"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p *ngIf="selectedProducts.length === 0" class="text-sm text-gray-500 italic">
                            No hay productos seleccionados
                        </p>
                    </div>

                </div>
            </div>

            <!-- Dates -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                    <input formControlName="fecha_inicio" type="date"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
                    <input formControlName="fecha_fin" type="date"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                </div>
            </div>

            <!-- Actions -->
            <div class="pt-6 flex justify-end space-x-3">
                <button type="button" routerLink="/admin/promociones"
                    class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancelar
                </button>
                <button type="submit" [disabled]="form.invalid || loading"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50">
                    {{ loading ? 'Guardando...' : 'Guardar Promoción' }}
                </button>
            </div>

        </form>
    </div>
</div>